# üöÄ GUIDE COMPLET - EX√âCUTION SUR MACHINE LOCALE

## üìã CONTEXTE

Vous avez une application en production sur Vercel avec:
- ‚úÖ Backend fonctionnel avec base de donn√©es Supabase
- ‚úÖ Frontend Angular d√©ploy√©
- ‚úÖ Infrastructure cache compl√®te cr√©√©e (PHASE 1-4)
- ‚úÖ Migration Prisma `add_updated_at_fields` **APPLIQU√âE** (27/01/2026)
- ‚è∏Ô∏è 4 services √† adapter (entrainement, tag, echauffement, situationmatch)
- ‚è∏Ô∏è PreloadService √† cr√©er
- ‚è∏Ô∏è Tests √† effectuer

---

## üéØ OBJECTIF

Appliquer toutes les modifications du syst√®me de cache multi-niveaux sur votre machine locale, puis d√©ployer en production.

---

## ‚úÖ PR√âREQUIS SUR VOTRE MACHINE

- [ ] Node.js 20.x install√©
- [ ] npm install√©
- [ ] Git install√©
- [ ] Acc√®s au repo GitHub
- [ ] Variables d'environnement disponibles

---

## üì¶ √âTAPE 1: R√âCUP√âRER LE CODE (5 min)

### 1.1 Cloner ou Pull le Repo

```powershell
# Si d√©j√† clon√©
cd C:\Users\v.coutry\AppData\Local\Programs\PROJETS\Ultimate-frisbee-manager
git pull origin main

# Si nouveau clone
git clone https://github.com/Kinder2149/Ultimate-frisbee-manager.git
cd Ultimate-frisbee-manager
```

### 1.2 V√©rifier les Nouveaux Fichiers

Fichiers cr√©√©s lors de notre session:

**Infrastructure Cache:**
- `frontend/src/app/core/models/cache.model.ts`
- `frontend/src/app/core/services/indexed-db.service.ts`
- `frontend/src/app/core/services/data-cache.service.ts` (modifi√©)
- `frontend/src/app/core/services/sync.service.ts`

**Backend:**
- `backend/routes/sync.routes.js`
- `backend/routes/index.js` (modifi√©)
- `backend/prisma/schema.prisma` (modifi√© - champ `updatedAt` ajout√©)
- `backend/prisma/migrations/add_updated_at_fields.sql`

**Services Adapt√©s:**
- `frontend/src/app/core/services/auth.service.ts` (modifi√©)
- `frontend/src/app/core/services/workspace.service.ts` (modifi√©)
- `frontend/src/app/core/services/exercice.service.ts` (modifi√©)

**Documentation:**
- `SERVICE_ADAPTATION_TEMPLATE.md`
- `FINAL_IMPLEMENTATION_SUMMARY.md`
- `DEPLOYMENT_GUIDE.md`
- `backend/.env.codespaces` (vos vraies variables)

---

## üóÑÔ∏è √âTAPE 2: CONFIGURATION BACKEND (10 min)

### 2.1 Cr√©er le fichier .env

```powershell
cd backend
cp .env.example .env
```

### 2.2 √âditer backend/.env avec vos vraies valeurs

Ouvrir `backend/.env` et remplacer par:

```env
# Base de donn√©es Supabase (Transaction mode pour production)
DATABASE_URL="postgresql://postgres.rnreaaeiccqkwgwxwxeg:0%40816N7m661C@aws-1-eu-west-3.pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"

# JWT Secrets
JWT_SECRET="k8mP2vN9xQ4wR7tY3uZ6aB1cD5eF0gH8iJ2kL4mN7oP9qR3sT6uV8wX1yZ4aB7cD"
JWT_REFRESH_SECRET="9nM6kJ3hG1fE4dC7bA0zY8xW5vU2tS9rQ6pO3nM0lK7jI4hG1fE8dC5bA2zY9xW6v"
JWT_EXPIRES_IN="7d"
JWT_REFRESH_EXPIRES_IN="30d"

# Port
PORT=3000
NODE_ENV=development

# CORS
CORS_ORIGINS="https://ultimate-frisbee-manager.vercel.app,http://localhost:4200"

# Cloudinary
CLOUDINARY_URL="cloudinary://937631178698815:N4HlT6CFvZbnffM62qudAUc313g@dmiqnc2o6"
CLOUDINARY_CLOUD_NAME="dmiqnc2o6"
CLOUDINARY_API_KEY="937631178698815"
CLOUDINARY_API_SECRET="N4HlT6CFvZbnffM62qudAUc313g"

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX=100
RATE_LIMIT_ENABLED=true
```

### 2.3 Installer les D√©pendances Backend

```powershell
npm install
```

---

## üîÑ √âTAPE 3: MIGRATION PRISMA (5 min)

### 3.1 V√©rifier la Version Prisma

```powershell
npx prisma --version
```

Doit afficher: `prisma: 5.22.0`

### 3.2 Appliquer la Migration

**‚úÖ MIGRATION D√âJ√Ä APPLIQU√âE (27/01/2026)**

La migration a √©t√© appliqu√©e avec succ√®s via `prisma db push` en utilisant le port 5432 (Session mode).

**Si besoin de r√©appliquer (nouvelle machine) :**

```powershell
# Option recommand√©e : db push avec port 5432
$env:DATABASE_URL="postgresql://postgres.rnreaaeiccqkwgwxwxeg:0@816N7m661C@aws-1-eu-west-3.pooler.supabase.com:5432/postgres"
npx prisma db push
```

**Note** : Le port 6543 (Transaction mode) peut bloquer lors des migrations. Utiliser le port 5432 (Session mode) pour les op√©rations de migration.

### 3.3 G√©n√©rer le Client Prisma

```powershell
npx prisma generate
```

### 3.4 V√©rifier avec Prisma Studio (Optionnel)

```powershell
npx prisma studio
```

Ouvrir http://localhost:5555 et v√©rifier que le champ `updatedAt` existe sur:
- Exercice
- Tag
- Entrainement
- Echauffement
- SituationMatch

---

## üöÄ √âTAPE 4: D√âMARRER LE BACKEND (2 min)

```powershell
npm run dev
```

**R√©sultat attendu:**
```
[Startup] Server listening on http://0.0.0.0:3000
‚úÖ Database connected
```

### 4.1 Tester les Endpoints

Dans un nouveau terminal:

```powershell
# Health check
curl http://localhost:3000/api/sync/health

# Devrait retourner:
{"status":"ok","timestamp":"2026-01-27T..."}
```

**Si le serveur d√©marre correctement, la migration est R√âUSSIE !** ‚úÖ

---

## üé® √âTAPE 5: CONFIGURATION FRONTEND (5 min)

### 5.1 Installer les D√©pendances Frontend

```powershell
cd ../frontend
npm install
```

### 5.2 V√©rifier environment.ts

Ouvrir `frontend/src/environments/environment.ts`:

```typescript
export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000/api',  // Backend local
  supabaseUrl: 'https://rnreaaeiccqkwgwxwxeg.supabase.co',
  supabaseKey: 'votre_anon_key'
};
```

### 5.3 D√©marrer le Frontend

```powershell
ng serve
```

Ouvrir http://localhost:4200

---

## üìù √âTAPE 6: ADAPTER LES 4 SERVICES RESTANTS (1h)

Utiliser le template `SERVICE_ADAPTATION_TEMPLATE.md` pour adapter:

### 6.1 EntrainementService

Fichier: `frontend/src/app/core/services/entrainement.service.ts`

**Modifications √† faire:**

```typescript
import { DataCacheService } from './data-cache.service';
import { SyncService } from './sync.service';
import { CacheOptions } from '../models/cache.model';

constructor(
  private http: HttpClient,
  private cache: DataCacheService,
  private sync: SyncService
) {}

getEntrainements(options: CacheOptions = {}): Observable<Entrainement[]> {
  return this.cache.get<Entrainement[]>(
    'entrainements-list',
    'entrainements',
    () => this.http.get<Entrainement[]>(this.apiUrl),
    options
  );
}

createEntrainement(data: Partial<Entrainement>): Observable<Entrainement> {
  return this.http.post<Entrainement>(this.apiUrl, data).pipe(
    tap((entrainement) => {
      this.cache.invalidate('entrainements-list', 'entrainements');
      this.sync.notifyChange({
        type: 'entrainement',
        action: 'create',
        id: entrainement.id,
        workspaceId: this.cache.getCurrentWorkspaceId() || '',
        timestamp: Date.now()
      });
    })
  );
}

// M√™me logique pour update, delete
```

### 6.2 TagService

Fichier: `frontend/src/app/core/services/tag.service.ts`

M√™me pattern que EntrainementService.

### 6.3 EchauffementService

Fichier: `frontend/src/app/core/services/echauffement.service.ts`

M√™me pattern que EntrainementService.

### 6.4 SituationMatchService

Fichier: `frontend/src/app/core/services/situationmatch.service.ts`

M√™me pattern que EntrainementService.

---

## üîÑ √âTAPE 7: CR√âER PRELOADSERVICE (30 min)

### 7.1 Cr√©er le Service

Fichier: `frontend/src/app/core/services/preload.service.ts`

```typescript
import { Injectable } from '@angular/core';
import { forkJoin, Observable, of } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { ExerciceService } from './exercice.service';
import { EntrainementService } from './entrainement.service';
import { TagService } from './tag.service';
import { EchauffementService } from './echauffement.service';
import { SituationMatchService } from './situationmatch.service';
import { WorkspaceService } from './workspace.service';

@Injectable({
  providedIn: 'root'
})
export class PreloadService {
  constructor(
    private exerciceService: ExerciceService,
    private entrainementService: EntrainementService,
    private tagService: TagService,
    private echauffementService: EchauffementService,
    private situationMatchService: SituationMatchService,
    private workspaceService: WorkspaceService
  ) {}

  preloadWorkspaceData(): Observable<any> {
    const currentWorkspace = this.workspaceService.getCurrentWorkspace();
    
    if (!currentWorkspace) {
      return of(null);
    }

    console.log('[Preload] Starting workspace data preload...');

    return forkJoin({
      exercices: this.exerciceService.getExercices({ staleWhileRevalidate: true }).pipe(
        catchError(err => {
          console.error('[Preload] Exercices failed:', err);
          return of([]);
        })
      ),
      entrainements: this.entrainementService.getEntrainements({ staleWhileRevalidate: true }).pipe(
        catchError(err => {
          console.error('[Preload] Entrainements failed:', err);
          return of([]);
        })
      ),
      tags: this.tagService.getTags({ staleWhileRevalidate: true }).pipe(
        catchError(err => {
          console.error('[Preload] Tags failed:', err);
          return of([]);
        })
      ),
      echauffements: this.echauffementService.getEchauffements({ staleWhileRevalidate: true }).pipe(
        catchError(err => {
          console.error('[Preload] Echauffements failed:', err);
          return of([]);
        })
      ),
      situations: this.situationMatchService.getSituations({ staleWhileRevalidate: true }).pipe(
        catchError(err => {
          console.error('[Preload] Situations failed:', err);
          return of([]);
        })
      )
    }).pipe(
      tap(() => console.log('[Preload] Workspace data preloaded successfully'))
    );
  }
}
```

### 7.2 Int√©grer dans AppComponent

Fichier: `frontend/src/app/app.component.ts`

```typescript
import { PreloadService } from './core/services/preload.service';
import { WorkspaceService } from './core/services/workspace.service';

export class AppComponent implements OnInit {
  constructor(
    private preloadService: PreloadService,
    private workspaceService: WorkspaceService
  ) {}

  ngOnInit() {
    // Pr√©charger les donn√©es au d√©marrage
    this.workspaceService.currentWorkspace$.subscribe(workspace => {
      if (workspace) {
        this.preloadService.preloadWorkspaceData().subscribe();
      }
    });
  }
}
```

---

## üß™ √âTAPE 8: TESTS COMPLETS (1h)

### 8.1 Test Backend

```powershell
cd backend

# Test health
curl http://localhost:3000/api/sync/health

# Test versions (n√©cessite token)
# R√©cup√©rer un token via login, puis:
curl http://localhost:3000/api/sync/versions \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "X-Workspace-Id: YOUR_WORKSPACE_ID"
```

### 8.2 Test Frontend - Cache IndexedDB

1. Ouvrir http://localhost:4200
2. Se connecter
3. Ouvrir DevTools ‚Üí Application ‚Üí IndexedDB
4. V√©rifier que la base `ufm-cache` existe avec les stores:
   - auth
   - workspaces
   - exercices
   - entrainements
   - tags
   - echauffements
   - situations

### 8.3 Test Cache Profil

1. Se connecter
2. Rafra√Æchir la page (F5)
3. V√©rifier dans Console:
   ```
   [Auth] Loaded cached profile
   [Auth] Syncing profile in background
   ```

### 8.4 Test Cache Exercices

1. Aller sur la liste des exercices
2. V√©rifier dans Console:
   ```
   [DataCache] Cache MISS for exercices-list, fetching...
   [DataCache] Data fetched for exercices-list
   ```
3. Rafra√Æchir (F5)
4. V√©rifier:
   ```
   [DataCache] Cache HIT for exercices-list
   ```

### 8.5 Test Synchronisation Multi-Onglets

1. Ouvrir 2 onglets sur http://localhost:4200
2. Dans l'onglet 1: Cr√©er un exercice
3. Dans l'onglet 2: V√©rifier que la liste se met √† jour automatiquement
4. Console onglet 2:
   ```
   [Sync] Received change notification: exercice
   [DataCache] Invalidated exercices-list
   ```

### 8.6 Test Changement de Workspace

1. Changer de workspace
2. V√©rifier dans Console:
   ```
   [Workspace] Changing workspace from X to Y
   [IndexedDB] Cleared workspace X data
   [Preload] Starting workspace data preload...
   ```
3. V√©rifier que la page se recharge automatiquement

---

## üìä √âTAPE 9: V√âRIFICATION FINALE (15 min)

### 9.1 Checklist Backend

- [x] Migration Prisma appliqu√©e avec succ√®s ‚úÖ
- [x] Champ `updatedAt` pr√©sent sur toutes les tables ‚úÖ
- [x] Endpoint `/api/sync/health` retourne OK ‚úÖ
- [ ] Endpoint `/api/sync/versions` retourne les timestamps
- [x] Serveur d√©marre sans erreur ‚úÖ

### 9.2 Checklist Frontend

- [ ] IndexedDB initialis√© avec tous les stores
- [ ] Cache profil fonctionne (F5 charge depuis cache)
- [ ] Cache exercices fonctionne (HIT apr√®s premier chargement)
- [ ] Synchronisation multi-onglets fonctionne
- [ ] Changement workspace nettoie le cache et recharge
- [ ] Aucune erreur dans la console

### 9.3 Checklist Services

- [x] ExerciceService adapt√© ‚úÖ
- [ ] EntrainementService adapt√©
- [ ] TagService adapt√©
- [ ] EchauffementService adapt√©
- [ ] SituationMatchService adapt√©
- [ ] PreloadService cr√©√© et int√©gr√©

---

## üöÄ √âTAPE 10: D√âPLOIEMENT PRODUCTION (15 min)

### 10.1 Commit et Push

```powershell
git add .
git commit -m "feat: Add multi-level cache system with IndexedDB and sync"
git push origin main
```

### 10.2 Vercel Red√©ploie Automatiquement

Vercel d√©tecte le push et red√©ploie automatiquement:
- Backend: Applique la migration Prisma
- Frontend: Build et d√©ploie

### 10.3 V√©rifier le D√©ploiement

1. Aller sur https://vercel.com/
2. V√©rifier que le d√©ploiement est r√©ussi
3. Tester l'URL de production:
   ```
   https://ultimate-frisbee-manager.vercel.app
   ```

### 10.4 V√©rifier la Migration en Production

```powershell
# Depuis votre machine locale
curl https://votre-backend.vercel.app/api/sync/health

# Devrait retourner:
{"status":"ok","timestamp":"..."}
```

---

## üìã R√âSUM√â DES COMMANDES COMPL√àTES

```powershell
# 1. Backend
cd backend
cp .env.example .env
# √âditer .env avec vos vraies valeurs
npm install
npx prisma migrate dev --name add_updated_at_fields
npx prisma generate
npm run dev

# 2. Frontend (nouveau terminal)
cd frontend
npm install
ng serve

# 3. Tests
# Ouvrir http://localhost:4200
# Tester cache, sync, workspace change

# 4. Adapter les 4 services restants
# Utiliser SERVICE_ADAPTATION_TEMPLATE.md

# 5. Cr√©er PreloadService
# Suivre √âTAPE 7

# 6. D√©ploiement
git add .
git commit -m "feat: Add multi-level cache system"
git push origin main
```

---

## üÜò R√âSOLUTION DE PROBL√àMES

### Erreur: "Can't reach database server"

**Solution**: V√©rifier `DATABASE_URL` dans `.env`

### Erreur: "Migration already applied"

**Solution**: Normal si d√©j√† fait en production. Utiliser `npx prisma migrate deploy`

### Erreur: "nodemon not found"

**Solution**: `npm install nodemon --save-dev`

### Frontend: "Cannot find module '@angular/core'"

**Solution**: `cd frontend && npm install`

### Cache ne fonctionne pas

**Solution**: V√©rifier dans DevTools ‚Üí Application ‚Üí IndexedDB que `ufm-cache` existe

---

## üìä TEMPS ESTIM√â TOTAL

- Configuration: 20 min
- Migration Prisma: 5 min
- Adaptation 4 services: 1h
- PreloadService: 30 min
- Tests: 1h
- D√©ploiement: 15 min

**Total: ~3h15**

---

## ‚úÖ R√âSULTAT FINAL

Une fois termin√©, vous aurez:

‚úÖ **Syst√®me de cache multi-niveaux complet**
- Cache m√©moire (5 min TTL)
- Cache IndexedDB (24h pour auth, 30min-1h pour data)
- Synchronisation automatique toutes les 30s
- Communication multi-onglets via BroadcastChannel

‚úÖ **Performance optimis√©e**
- Chargement instantan√© depuis cache
- Stale-while-revalidate pour UX fluide
- Pr√©chargement au d√©marrage
- Mini-reload transparent sur changement workspace

‚úÖ **Production ready**
- Backend d√©ploy√© sur Vercel
- Frontend d√©ploy√© sur Vercel
- Base de donn√©es Supabase
- Migration Prisma appliqu√©e

---

**Bonne chance pour l'ex√©cution sur votre machine locale !** üöÄ
