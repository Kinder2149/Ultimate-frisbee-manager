<div class="app-container" [class.mobile-route]="isMobileRoute" (click)="closeAllDropdowns()">
  <div class="appbar-backdrop" *ngIf="isAnyMenuOpen" (click)="$event.stopPropagation(); closeAllDropdowns()"></div>
  <header class="main-header" #mainHeader *ngIf="!isMobileRoute">
    <div class="container">
      <div class="appbar">
        <div class="appbar__left">
          <div class="appbar__row appbar__row--title">
            <h1>{{ title }}</h1>
            <span class="badge badge-base" *ngIf="permissionsService.isBaseWorkspace()" title="Workspace BASE - Réservé aux administrateurs">
              <mat-icon>lock</mat-icon>
              BASE
            </span>
          </div>
        </div>
        <div class="appbar__row appbar__row--nav">
          <nav class="main-nav" (click)="$event.stopPropagation()">
            <ul>
          <li><a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" matTooltip="Tableau de bord">
            <mat-icon>dashboard</mat-icon>
            <span class="nav-text">Tableau de bord</span>
          </a></li>

          <!-- Menu déroulant Exercices -->
          <li class="dropdown exercices" [class.open]="isDropdownOpen.exercices">
            <a href="#" class="dropdown-toggle" (click)="toggleDropdown('exercices', $event)" matTooltip="Exercices">
              <mat-icon>fitness_center</mat-icon>
              <span class="nav-text">Exercices</span>
              <mat-icon class="dropdown-icon">expand_more</mat-icon>
            </a>
            <ul class="dropdown-menu" *ngIf="isDropdownOpen.exercices">
              <li><a routerLink="/exercices" routerLinkActive="active">Tous les exercices</a></li>
              <li *ngIf="((workspaceService.currentWorkspace$ | async)?.role && ((workspaceService.currentWorkspace$ | async)?.role || '').toUpperCase() !== 'VIEWER')"><a routerLink="/exercices/ajouter" routerLinkActive="active">Ajouter un exercice</a></li>
            </ul>
          </li>

          <!-- Menu déroulant Entraînements -->
          <li class="dropdown entrainements" [class.open]="isDropdownOpen.entrainements">
            <a href="#" class="dropdown-toggle" (click)="toggleDropdown('entrainements', $event)" matTooltip="Entraînements">
              <mat-icon>sports</mat-icon>
              <span class="nav-text">Entraînements</span>
              <mat-icon class="dropdown-icon">expand_more</mat-icon>
            </a>
            <ul class="dropdown-menu" *ngIf="isDropdownOpen.entrainements">
              <li><a routerLink="/entrainements" routerLinkActive="active">Tous les entraînements</a></li>
              <li *ngIf="((workspaceService.currentWorkspace$ | async)?.role && ((workspaceService.currentWorkspace$ | async)?.role || '').toUpperCase() !== 'VIEWER')"><a routerLink="/entrainements/nouveau" routerLinkActive="active">Nouvel entraînement</a></li>
            </ul>
          </li>

          <!-- Menu déroulant Échauffements -->
          <li class="dropdown echauffements" [class.open]="isDropdownOpen.echauffements">
            <a href="#" class="dropdown-toggle" (click)="toggleDropdown('echauffements', $event)" matTooltip="Échauffements">
              <mat-icon>directions_run</mat-icon>
              <span class="nav-text">Échauffements</span>
              <mat-icon class="dropdown-icon">expand_more</mat-icon>
            </a>
            <ul class="dropdown-menu" *ngIf="isDropdownOpen.echauffements">
              <li><a routerLink="/echauffements" routerLinkActive="active">Tous les échauffements</a></li>
              <li *ngIf="((workspaceService.currentWorkspace$ | async)?.role && ((workspaceService.currentWorkspace$ | async)?.role || '').toUpperCase() !== 'VIEWER')"><a routerLink="/echauffements/ajouter" routerLinkActive="active">Nouvel échauffement</a></li>
            </ul>
          </li>

          <!-- Menu déroulant Situations/Matchs -->
          <li class="dropdown situations" [class.open]="isDropdownOpen.situations">
            <a href="#" class="dropdown-toggle" (click)="toggleDropdown('situations', $event)" matTooltip="Situations/Matchs">
              <mat-icon>sports_soccer</mat-icon>
              <span class="nav-text">Situations/Matchs</span>
              <mat-icon class="dropdown-icon">expand_more</mat-icon>
            </a>
            <ul class="dropdown-menu" *ngIf="isDropdownOpen.situations">
              <li><a routerLink="/situations-matchs" routerLinkActive="active">Toutes les situations</a></li>
              <li *ngIf="((workspaceService.currentWorkspace$ | async)?.role && ((workspaceService.currentWorkspace$ | async)?.role || '').toUpperCase() !== 'VIEWER')"><a routerLink="/situations-matchs/ajouter" routerLinkActive="active">Nouvelle situation</a></li>
            </ul>
          </li>
          
          <!-- Menu utilisateur fusionné (Avatar + Paramètres) -->
          <li class="dropdown parametres user-avatar" [class.open]="isDropdownOpen.parametres">
            <a class="nav-link dropdown-toggle" href="#" (click)="toggleDropdown('parametres', $event)" matTooltip="Paramètres">
              <!-- Avatar avec photo de profil -->
              <div class="user-avatar-container">
                <img 
                  *ngIf="getAvatarUrl((currentUser$ | async)?.iconUrl)" 
                  [src]="getAvatarUrl((currentUser$ | async)?.iconUrl)" 
                  alt="Avatar" 
                  class="user-avatar-img"
                />
                <mat-icon *ngIf="!getAvatarUrl((currentUser$ | async)?.iconUrl)" class="user-avatar-icon">account_circle</mat-icon>
              </div>
              <span class="nav-text">Paramètres</span>
              <mat-icon class="dropdown-icon">expand_more</mat-icon>
            </a>
            <ul class="dropdown-menu" *ngIf="isDropdownOpen.parametres">
              <li *ngIf="((currentUser$ | async)?.role || '').toLowerCase() === 'admin'"><a routerLink="/parametres/admin" routerLinkActive="active">Tableau de bord Admin</a></li>
              <li *ngIf="((currentUser$ | async)?.role || '').toLowerCase() === 'admin'"><a routerLink="/parametres/import-export" routerLinkActive="active">Import/Export</a></li>
              <li *ngIf="isAuthenticated$ | async"><a routerLink="/parametres/profil" routerLinkActive="active">Profil</a></li>
              <li *ngIf="isAuthenticated$ | async"><a href="#" (click)="$event.preventDefault(); onLogout()">Déconnexion</a></li>
            </ul>
          </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <app-startup-loader *ngIf="showStartupLoader$ | async"></app-startup-loader>

  <main class="main-content">
    <div class="container">
      <router-outlet></router-outlet>
    </div>
  </main>

  <!-- Bulle de statut backend (affichage global) -->
  <app-status-bubble></app-status-bubble>

  <footer class="main-footer">
    <div class="container">
      <p>&copy; 2025 Ultimate Frisbee Manager</p>
    </div>
  </footer>
</div>
