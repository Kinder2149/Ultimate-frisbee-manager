<div class="ex-form">
  <!-- A — En-tête -->
  <div class="ex-header">
    <button type="button" class="btn btn-link" (click)="onCancel()">
      <mat-icon>arrow_back</mat-icon>
      <span>Retour</span>
    </button>
    <h1 class="title" *ngIf="mode==='create'">Créer un exercice</h1>
    <h1 class="title" *ngIf="mode==='edit'">Modifier l’exercice : {{ exerciceForm.get('nom')?.value || exercice.nom || '—' }}</h1>
  </div>

  <form [formGroup]="exerciceForm" (ngSubmit)="onSubmit()" class="ex-body" *ngIf="!readonlyMode">
    <!-- B — Informations générales -->
    <section class="card section">
      <h2 class="section-title">Informations générales</h2>
      <div class="grid">
        <!-- Ligne 1: Nom -->
        <div class="row">
          <div class="col col-12">
            <label for="nom" class="label">Nom</label>
            <input id="nom" type="text" class="input" formControlName="nom" [class.invalid]="submitted && f['nom'].errors" placeholder="Nom de l’exercice">
            <div class="error" *ngIf="submitted && f['nom'].errors && f['nom'].errors['required']">Le nom est requis.</div>
          </div>
        </div>
        <!-- Ligne 2: Objectif + Travail spécifique (restent des tags plus bas), Catégorie/Intensité non présents dans modèle actuel -->
        <div class="row">
          <div class="col col-6">
            <label class="label">Objectif</label>
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Objectif principal</mat-label>
              <mat-select formControlName="objectifTag" [compareWith]="compareTags">
                <mat-option [value]="null">Aucun</mat-option>
                <mat-option *ngFor="let tag of objectifTags" [value]="tag">{{ tag.label }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="col col-6">
            <label class="label">Travail spécifique</label>
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Travaux spécifiques</mat-label>
              <mat-select formControlName="travailSpecifiqueTags" multiple [compareWith]="compareTags">
                <mat-option *ngFor="let tag of travailSpecifiqueTags" [value]="tag">{{ tag.label }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
        <!-- Ligne 3: Durée + Nombre de joueurs (non présents -> utiliser tags/variables comme proxy) -->
        <div class="row">
          <div class="col col-6">
            <label class="label">Temps</label>
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Temps moyen</mat-label>
              <mat-select formControlName="tempsTags" multiple [compareWith]="compareTags">
                <mat-option *ngFor="let tag of tempsTags" [value]="tag">{{ tag.label }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="col col-6">
            <label class="label">Format</label>
            <mat-form-field appearance="fill" class="w-100">
              <mat-label>Formats</mat-label>
              <mat-select formControlName="formatTags" multiple [compareWith]="compareTags">
                <mat-option *ngFor="let tag of formatTags" [value]="tag">{{ tag.label }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>
    </section>

    <!-- C — Description (éditeur riche) -->
    <section class="card section">
      <h2 class="section-title">Description</h2>
      <app-rich-text-editor formControlName="description" [placeholder]="'Décris l\'exercice…'"></app-rich-text-editor>
      <div class="error" *ngIf="submitted && f['description'].errors && f['description'].errors['required']">La description est requise.</div>
    </section>

    <!-- D — Points importants -->
    <section class="card section">
      <div class="section-header">
        <h2 class="section-title">Points importants</h2>
        <button type="button" class="btn btn-small" (click)="addPoint()"><mat-icon>add</mat-icon>Ajouter un point</button>
      </div>
      <div class="points">
        <div class="point-item" *ngFor="let ctrl of pointsControls; let i = index">
          <input class="input" [formControl]="ctrl" placeholder="Saisir un point clé...">
          <button type="button" class="icon-btn" (click)="removePoint(i)"><mat-icon>delete</mat-icon></button>
        </div>
        <div class="hint muted">Ces points sont visuels pour l’instant et ne modifient pas l’API.</div>
      </div>
    </section>

    <!-- E — Variables (+ / -) -->
    <section class="card section">
      <h2 class="section-title">Variables</h2>
      <app-exercice-variables formControlName="variables"></app-exercice-variables>
    </section>

    <!-- F — Schémas (multi-upload UI) -->
    <section class="card section">
      <div class="section-header">
        <h2 class="section-title">Schémas</h2>
        <span class="muted">Aucun schéma ajouté pour le moment si la grille est vide.</span>
      </div>
      <div class="schema-grid">
        <div class="schema-card" *ngIf="imagePreviewString">
          <img [src]="imagePreviewString" alt="Illustration">
          <span class="caption">Illustration</span>
        </div>
        <div class="schema-card" *ngIf="f['schemaUrl'].value">
          <img [src]="mediaUrl(f['schemaUrl'].value) || f['schemaUrl'].value" alt="Schéma">
          <span class="caption">Schéma</span>
        </div>
      </div>
      <div class="upload-row">
        <app-image-upload [currentImageUrl]="imagePreviewString" [context]="'exercices'" (imageSelected)="onImageSelected($event)"></app-image-upload>
        <div class="form-group">
          <label for="schemaUrl" class="label">URL du schéma</label>
          <input id="schemaUrl" type="text" class="input" formControlName="schemaUrl" placeholder="https://…">
        </div>
      </div>
    </section>

    <!-- G — Tags (groupes) -->
    <section class="card section">
      <h2 class="section-title">Tags</h2>
      <div class="grid">
        <div class="col col-6">
          <h3 class="group-title">Niveau</h3>
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>Niveaux</mat-label>
            <mat-select formControlName="niveauTags" multiple [compareWith]="compareTags">
              <mat-option *ngFor="let tag of niveauTags" [value]="tag">{{ tag.label }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col col-6">
          <h3 class="group-title">Temps</h3>
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>Temps</mat-label>
            <mat-select formControlName="tempsTags" multiple [compareWith]="compareTags">
              <mat-option *ngFor="let tag of tempsTags" [value]="tag">{{ tag.label }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col col-6">
          <h3 class="group-title">Format</h3>
          <mat-form-field appearance="fill" class="w-100">
            <mat-label>Formats</mat-label>
            <mat-select formControlName="formatTags" multiple [compareWith]="compareTags">
              <mat-option *ngFor="let tag of formatTags" [value]="tag">{{ tag.label }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>
    </section>

    <!-- Divers -->
    <section class="card section">
      <h2 class="section-title">Compléments</h2>
      <div class="grid">
        <div class="col col-6">
          <label for="materiel" class="label">Matériel</label>
          <input id="materiel" type="text" class="input" formControlName="materiel" placeholder="Ex: 10 cônes, 5 disques…">
        </div>
        <div class="col col-6">
          <label for="imageUrl" class="label">URL de l’image</label>
          <input id="imageUrl" type="text" class="input" formControlName="imageUrl" placeholder="https://…">
        </div>
        <div class="col col-12">
          <label for="notes" class="label">Notes</label>
          <textarea id="notes" rows="3" class="textarea" formControlName="notes" placeholder="Notes complémentaires, consignes…"></textarea>
        </div>
        <div class="col col-12">
          <label for="critereReussite" class="label">Critère de réussite</label>
          <textarea id="critereReussite" rows="3" class="textarea" formControlName="critereReussite" placeholder="Ex: Réussir 8 passes consécutives…"></textarea>
        </div>
      </div>
    </section>

    <!-- H — Boutons d'action -->
    <div class="actions">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">Annuler</button>
      <button type="submit" class="btn btn-primary">{{ editMode ? 'Enregistrer' : 'Créer' }}</button>
    </div>
  </form>

  <div *ngIf="readonlyMode" class="info muted">Le mode lecture seule n'est pas concerné par la refonte UI.</div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert error">{{ errorMessage }}</div>
</div>