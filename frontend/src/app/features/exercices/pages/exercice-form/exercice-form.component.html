<div class="container">
  <!-- Titres contextuels (pas de titre en lecture seule pour éviter la redondance) -->
  <h2 *ngIf="mode === 'create'">Ajouter un exercice d'ultimate frisbee</h2>
  <h2 *ngIf="mode === 'edit'">Modifier: {{ exerciceForm.get('nom')?.value || exercice.nom || 'Exercice' }}</h2>

  

  <!-- Vue Lecture Seule harmonisée avec les entraînements -->
  <div *ngIf="readonlyMode" class="themed-card exercice-theme">
    <div class="themed-content">
      <h2 class="view-title" style="margin-top:0;">{{ exerciceForm.get('nom')?.value || exercice.nom }}</h2>
      <!-- Grille principale -->
      <div class="view-grid">
        <!-- Colonne gauche: Description -->
        <section class="view-section view-span-2">
          <h3 class="view-heading">Description</h3>
          <p class="view-text">{{ exerciceForm.get('description')?.value }}</p>
        </section>

        <!-- Colonne droite: Image ou placeholder -->
        <section class="view-section">
          <ng-container *ngIf="imagePreview; else imagePlaceholder">
            <div class="media-item">
              <img [src]="imagePreview" alt="Illustration de l'exercice" />
              <div class="media-caption">Illustration</div>
            </div>
          </ng-container>
          <ng-template #imagePlaceholder>
            <div class="image-placeholder">
              <span class="material-icons">image</span>
              <span>Ajouter une image</span>
            </div>
          </ng-template>
        </section>

        <section class="view-section">
          <h3 class="view-heading sand">Temps moyen</h3>
          <!-- Affiche les tags TEMPS si présents, sinon repli sur la durée libre -->
          <div class="tags-display" *ngIf="selectedTempsTags?.length; else dureeFallback">
            <span class="tag" *ngFor="let tag of selectedTempsTags" [style.background-color]="tag.color || '#e0e0e0'">{{ tag.label }}</span>
          </div>
          <ng-template #dureeFallback>
            <div class="muted" *ngIf="exerciceForm.get('variables')?.value as vars">{{ vars.duree || '—' }}</div>
          </ng-template>
        </section>

        <!-- Notes -->
        <section class="view-section view-span-3">
          <h3 class="view-heading violet">Notes</h3>
          <div class="view-text" *ngIf="exerciceForm.get('variables')?.value as vars">{{ f['notes'].value || vars.consignes || '—' }}</div>
        </section>

        <!-- Critère de réussite -->
        <section class="view-section view-span-3">
          <h3 class="view-heading">Critère de réussite</h3>
          <div class="view-text">{{ f['critereReussite'].value || '—' }}</div>
        </section>
      </div>
    </div>
  </div>

  <form *ngIf="!readonlyMode" [formGroup]="exerciceForm" (ngSubmit)="onSubmit()" class="edit-form">
    <div class="form-grid">
      <!-- Nom (plein largeur) -->
      <section class="form-section form-span-3">
        <h3 class="view-heading">Nom</h3>
        <input 
          type="text" 
          id="nom" 
          formControlName="nom" 
          class="form-control"
          [class.invalid]="submitted && f['nom'].errors"
        >
        <div *ngIf="submitted && f['nom'].errors" class="error-message">
          <div *ngIf="f['nom'].errors && f['nom'].errors['required']">Le nom est requis</div>
        </div>
      </section>

      <!-- Description (2 colonnes) -->
      <section class="form-section form-span-2">
        <h3 class="view-heading">Description</h3>
        <textarea 
          id="description" 
          formControlName="description" 
          class="form-control"
          [class.invalid]="submitted && f['description'].errors"
          rows="6"
        ></textarea>
        <div *ngIf="submitted && f['description'].errors" class="error-message">
          <div *ngIf="f['description'].errors && f['description'].errors['required']">La description est requise</div>
        </div>
      </section>

      <!-- Tuile image (1 colonne) + upload -->
      <section class="form-section">
        <h3 class="view-heading">Illustration</h3>
        <app-image-upload 
          [currentImageUrl]="f['imageUrl'].value"
          (imageSelected)="onImageSelected($event)">
        </app-image-upload>
        <div class="form-group" style="margin-top:10px;">
          <label for="imageUrl">URL de l'image</label>
          <input type="text" id="imageUrl" formControlName="imageUrl" class="form-control" placeholder="https://exemple.com/image.jpg">
        </div>
        <div class="form-group" style="margin-top:8px;">
          <label for="schemaUrl">URL du schéma</label>
          <input type="text" id="schemaUrl" formControlName="schemaUrl" class="form-control" placeholder="https://exemple.com/schema.jpg">
        </div>
      </section>

      <!-- Objectif -->
      <section class="form-section">
        <h3 class="view-heading light-blue">Objectif</h3>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Objectif principal</mat-label>
          <mat-select formControlName="objectifTag" [compareWith]="compareTags">
            <mat-option [value]="null">Aucun</mat-option>
            <mat-option *ngFor="let tag of objectifTags" [value]="tag">
              {{ tag.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </section>

      <!-- Travail spécifique -->
      <section class="form-section">
        <h3 class="view-heading light-blue">Travail Spécifique</h3>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Travaux spécifiques</mat-label>
          <mat-select formControlName="travailSpecifiqueTags" multiple [compareWith]="compareTags">
            <mat-option *ngFor="let tag of travailSpecifiqueTags" [value]="tag">{{ tag.label }}</mat-option>
          </mat-select>
        </mat-form-field>
      </section>

      <!-- Variables (plein largeur) -->
      <section class="form-section form-span-3">
        <h3 class="view-heading green">Variables</h3>
        <app-exercice-variables formControlName="variables"></app-exercice-variables>
      </section>

      <!-- Matériel (1 colonne) -->
      <section class="form-section">
        <h3 class="view-heading sand">Matériel</h3>
        <input 
          type="text" 
          id="materiel"
          formControlName="materiel"
          class="form-control"
          placeholder="Ex: 10 cônes, 5 disques..."
        >
      </section>

      <!-- Notes (2 colonnes) -->
      <section class="form-section form-span-2">
        <h3 class="view-heading violet">Notes</h3>
        <textarea 
          id="notes" 
          formControlName="notes" 
          class="form-control"
          rows="4"
          placeholder="Notes complémentaires, consignes particulières, adaptations..."
        ></textarea>
      </section>

      <!-- Critère de réussite (plein largeur) -->
      <section class="form-section form-span-3">
        <h3 class="view-heading">Critère de réussite</h3>
        <textarea
          id="critereReussite"
          formControlName="critereReussite"
          class="form-control"
          rows="3"
          placeholder="Ex: Réussir 8 passes consécutives sans turnover"
        ></textarea>
      </section>

      <!-- Niveau -->
      <section class="form-section">
        <h3 class="view-heading">Niveau</h3>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Niveaux</mat-label>
          <mat-select formControlName="niveauTags" multiple [compareWith]="compareTags">
            <mat-option *ngFor="let tag of niveauTags" [value]="tag">{{ tag.label }}</mat-option>
          </mat-select>
        </mat-form-field>
      </section>

      <!-- Temps moyen -->
      <section class="form-section">
        <h3 class="view-heading">Temps moyen</h3>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Temps</mat-label>
          <mat-select formControlName="tempsTags" multiple [compareWith]="compareTags">
            <mat-option *ngFor="let tag of tempsTags" [value]="tag">{{ tag.label }}</mat-option>
          </mat-select>
        </mat-form-field>
      </section>

      <!-- Format -->
      <section class="form-section">
        <h3 class="view-heading sand">Format</h3>
        <mat-form-field appearance="fill" class="w-full">
          <mat-label>Formats</mat-label>
          <mat-select formControlName="formatTags" multiple [compareWith]="compareTags">
            <mat-option *ngFor="let tag of formatTags" [value]="tag">{{ tag.label }}</mat-option>
          </mat-select>
        </mat-form-field>
      </section>

      <!-- Boutons d'action (plein largeur) -->
      <section class="form-section form-span-3 submit-section">
        <div class="d-flex justify-content-between">
          <button type="submit" class="btn btn-primary" *ngIf="!editMode">Ajouter l'exercice</button>
          <div *ngIf="editMode" class="d-flex gap-3">
            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
            <button type="button" class="btn btn-secondary" (click)="onCancel()">Annuler</button>
          </div>
        </div>
      </section>
    </div>
  </form>

  <!-- Message de confirmation/erreur -->
  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="error-message">
    {{ errorMessage }}
  </div>
</div>