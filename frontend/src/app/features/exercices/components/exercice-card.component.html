<div class="exercice-card-container" [ngSwitch]="mode">

  <!-- MODE SUMMARY: Affiche juste le contenu, sans la boîte de la carte -->
  <ng-container *ngSwitchCase="'entrainement-summary'">
    <ng-container *ngTemplateOutlet="cardContent"></ng-container>
  </ng-container>

  <!-- MODE DEFAULT / ENTRAINEMENT: Affiche la carte complète -->
  <ng-container *ngSwitchDefault>
    <div class="exercice-card entity-card">
      <!-- EN-TÊTE (clic pour déplier/replier) -->
      <div class="card-header" (click)="toggleExpanded($event)" (keydown.enter)="toggleExpanded($event)" (keydown.space)="toggleExpanded($event)" tabindex="0">
        <div class="title-section">
          <div class="title-left">
            <span *ngIf="index as idx" class="index-bubble">{{ idx }}</span>
            <h3 class="card-title">{{ exercice.nom }}</h3>
          </div>
          <div class="header-badge">
            <span class="badge badge-exercice">Exercice</span>
            <!-- Tags essentiels dans l'en-tête -->
            <mat-chip *ngIf="objectifTag" [style.background-color]="objectifTag.color || '#34A853'" [style.color]="'#fff'">{{ objectifTag.label }}</mat-chip>
            <mat-chip *ngFor="let tag of travailSpecifiqueTags" [style.background-color]="tag.color || '#1E88E5'" [style.color]="'#fff'">{{ tag.label }}</mat-chip>
            <span *ngIf="dureeDisplay && !allowEditDuration" class="duration-pill">
              <mat-icon class="duration-icon">schedule</mat-icon>
              {{ dureeDisplay }}
            </span>
            <span *ngIf="mode === 'entrainement' && allowEditDuration" class="duration-pill">
              <button mat-icon-button (click)="incrementDuration(-1)" matTooltip="-1 min"><mat-icon>remove</mat-icon></button>
              <mat-icon class="duration-icon">schedule</mat-icon>
              {{ dureeDisplay || '0 min' }}
              <button mat-icon-button (click)="incrementDuration(1)" matTooltip="+1 min"><mat-icon>add</mat-icon></button>
            </span>
          </div>
        </div>
        <div class="card-actions" (click)="$event.stopPropagation()" *ngIf="mode === 'default'">
            <button mat-icon-button (click)="viewExercice($event)" matTooltip="Voir"><mat-icon>visibility</mat-icon></button>
            <button mat-icon-button (click)="editExercice($event)" matTooltip="Modifier"><mat-icon>edit</mat-icon></button>
            <app-duplicate-button 
              [entityId]="exercice.id!" 
              entityType="exercice"
              [loading]="duplicating"
              (duplicate)="duplicateExercice($event)">
            </app-duplicate-button>
            <button mat-icon-button (click)="deleteExercice($event)" matTooltip="Supprimer" class="delete-btn"><mat-icon>delete</mat-icon></button>
            <button mat-icon-button class="chevron" (click)="toggleExpanded($event)" [attr.aria-expanded]="expanded" [matTooltip]="expanded ? 'Replier' : 'Déplier'">
              <mat-icon [ngClass]="{ 'rotated': expanded }">expand_more</mat-icon>
            </button>
        </div>
      </div>

      <!-- Contenu de la carte -->
      <ng-container *ngIf="expanded">
        <ng-container *ngTemplateOutlet="cardContent"></ng-container>
      </ng-container>

    </div>
  </ng-container>

</div>


<!-- TEMPLATE REUTILISABLE POUR LE CONTENU DE LA CARTE -->
<ng-template #cardContent>
  <!-- Image ou espace réservé -->
  <div class="image-container" [class.has-image]="exercice.imageUrl" [class.no-image]="!exercice.imageUrl">
    <img *ngIf="exercice.imageUrl" [src]="mediaUrl(exercice.imageUrl)" alt="Illustration de l'exercice" class="clickable" (click)="onImageClicked(exercice.imageUrl)">
  </div>

  <!-- CONTENU -->
  <div class="card-content">
    <!-- Description (rich text) -->
    <div class="description-section" *ngIf="exercice.description">
      <h4 class="section-title">Description</h4>
      <app-rich-text-view [html]="exercice.description"></app-rich-text-view>
    </div>

    <!-- Critère de réussite -->
    <div class="description-section" *ngIf="exercice.critereReussite">
      <h4 class="section-title">Critère de réussite</h4>
      <p class="description">{{ exercice.critereReussite }}</p>
    </div>
    
    <div class="variables-text" *ngIf="exercice.variablesText">
      <h4>Variables:</h4>
      <p>{{ exercice.variablesText }}</p>
    </div>

    <div class="schema" *ngIf="exercice.schemaUrl">
      <img [src]="mediaUrl(exercice.schemaUrl)" alt="Schéma de l'exercice" class="clickable" (click)="onImageClicked(exercice.schemaUrl)">
    </div>
    
    <div class="tags-section">
      <div class="tag-group" *ngIf="niveauTags.length > 0">
        <h4>Niveau:</h4>
        <div class="tags-container"><span class="tag tag--niveau" *ngFor="let tag of niveauTags" [style.background-color]="tag.color || '#34A853'">{{ tag.level ? '★'.repeat(tag.level) : tag.label }}</span></div>
      </div>
      <div class="tag-group" *ngIf="formatTags?.length">
        <h4>Format:</h4>
        <div class="tags-container"><mat-chip-listbox><mat-chip *ngFor="let tag of formatTags" [style.background-color]="tag.color || '#00BCD4'" [style.color]="'#fff'">{{ tag.label }}</mat-chip></mat-chip-listbox></div>
      </div>
    </div>
    
    <div class="notes-panel" *ngIf="notes">
      <h4>Notes pour cet entraînement :</h4>
      <p>{{ notes }}</p>
    </div>
  </div>

  <!-- PIED DE CARTE (uniquement quand déployé et en mode non-summary) -->
  <div class="meta-info" *ngIf="expanded && mode !== 'entrainement-summary'">
    <span class="created-at" *ngIf="exercice.createdAt">Créé le {{ exercice.createdAt | date:'dd/MM/yyyy' }}</span>
  </div>
</ng-template>