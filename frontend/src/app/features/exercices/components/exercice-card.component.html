<div class="exercice-card entity-card" [ngClass]="{ 'left-time': leftTime, 'right-time': !!dureeDisplay }">
  <!-- Rail temps à gauche -->
  <div *ngIf="leftTime && dureeDisplay" class="left-rail-time" aria-label="Durée">
    <mat-icon>schedule</mat-icon>
    <span>{{ dureeDisplay }}</span>
  </div>

  <!-- Rail temps à droite -->
  <div *ngIf="dureeDisplay" class="right-rail-time exercice" aria-label="Durée (droite)">
    <mat-icon>schedule</mat-icon>
    <span>{{ dureeDisplay }}</span>
  </div>

  <!-- EN-TÊTE -->
  <div class="card-header">
    <div class="title-section">
      <div class="title-left">
        <span *ngIf="index as idx" class="index-bubble">{{ idx }}</span>
        <h3 class="card-title">{{ exercice.nom }}</h3>
      </div>
      <div class="header-badge">
        <span class="badge badge-exercice">Exercice</span>
        <span *ngIf="!leftTime && dureeDisplay && !allowEditDuration" class="duration-pill">
          <mat-icon class="duration-icon">schedule</mat-icon>
          {{ dureeDisplay }}
        </span>
        <span *ngIf="mode === 'entrainement' && allowEditDuration" class="duration-pill">
          <button mat-icon-button (click)="incrementDuration(-1)" matTooltip="-1 min"><mat-icon>remove</mat-icon></button>
          <mat-icon class="duration-icon">schedule</mat-icon>
          {{ dureeDisplay || '0 min' }}
          <button mat-icon-button (click)="incrementDuration(1)" matTooltip="+1 min"><mat-icon>add</mat-icon></button>
        </span>
      </div>
    </div>
    <div class="card-actions" (click)="$event.stopPropagation()" *ngIf="mode === 'default'">
        <button mat-icon-button (click)="viewExercice($event)" matTooltip="Voir"><mat-icon>visibility</mat-icon></button>
        <button mat-icon-button (click)="editExercice($event)" matTooltip="Modifier"><mat-icon>edit</mat-icon></button>
        <app-duplicate-button 
          [entityId]="exercice.id!" 
          entityType="exercice"
          [loading]="duplicating"
          (duplicate)="duplicateExercice($event)">
        </app-duplicate-button>
        <button mat-icon-button (click)="deleteExercice($event)" matTooltip="Supprimer" class="delete-btn"><mat-icon>delete</mat-icon></button>
    </div>
  </div>

  <!-- Image -->
  <div class="image-container" *ngIf="exercice.imageUrl as url">
    <img [src]="mediaUrl(exercice.imageUrl)" alt="Illustration de l'exercice" class="clickable" (click)="onImageClicked(exercice.imageUrl)">
  </div>

  <!-- CONTENU -->
  <div class="card-content">

    <!-- Infos rapides pour mode entraînement -->
    <div class="training-quick-info" *ngIf="mode === 'entrainement'">
      <div class="info-row" *ngIf="exercice.description as desc"><span class="label">Description :</span><span class="value">{{ desc }}</span></div>
      <div class="info-row" *ngIf="exercice.schemaUrl">
        <button mat-stroked-button color="primary" (click)="toggleShowImage()">
          <mat-icon>{{ showImage ? 'hide_image' : 'image' }}</mat-icon>
          {{ showImage ? 'Masquer l\'image' : 'Afficher l\'image' }}
        </button>
      </div>
      <div class="schema" *ngIf="showImage && exercice.schemaUrl"><img [src]="exercice.schemaUrl" alt="Schéma de l'exercice" /></div>
      <div class="info-row" *ngIf="objectifTag"><span class="label">Objectif :</span><div class="tags-display"><span class="tag tag--objectif" [style.background-color]="objectifTag.color || '#34A853'">{{ objectifTag.label }}</span></div></div>
      <div class="info-row" *ngIf="travailSpecifiqueTags?.length"><span class="label">Travail :</span><div class="tags-display"><span class="tag tag--travail" *ngFor="let tag of travailSpecifiqueTags" [style.background-color]="tag.color || '#1E88E5'">{{ tag.label }}</span></div></div>
      <div class="info-row" *ngIf="exercice.variablesText as vars"><span class="label">Variables :</span><span class="value">{{ vars }}</span></div>
      <div class="info-row" *ngIf="formatTags?.length"><span class="label">Format :</span><div class="tags-display"><span class="tag tag--format" *ngFor="let tag of formatTags" [style.background-color]="tag.color || '#00BCD4'">{{ tag.label }}</span></div></div>
    </div>

    <!-- Lignes de résumé (visibles sans expansion) -->
    <div class="summary-rows">
      <div class="info-row" *ngIf="exercice.createdAt"><span class="label">Date :</span><span class="value">{{ exercice.createdAt | date:'dd/MM/yyyy' }}</span></div>
      <div class="info-row" *ngIf="objectifTag || travailSpecifiqueTags?.length"><span class="label">Thèmes :</span>
        <div class="tags-container">
          <mat-chip-listbox><mat-chip *ngIf="objectifTag" [style.background-color]="objectifTag.color || '#34A853'" [style.color]="'#fff'">{{ objectifTag.label }}</mat-chip><mat-chip *ngFor="let tag of travailSpecifiqueTags" [style.background-color]="tag.color || '#1E88E5'" [style.color]="'#fff'">{{ tag.label }}</mat-chip></mat-chip-listbox>
        </div>
      </div>
    </div>

    <!-- Contenu détaillé -->
    <div class="collapsible-content">
      <p class="description" *ngIf="exercice.description">{{ exercice.description }}</p>
      <div class="variables-text" *ngIf="exercice.variablesText"><h4>Variables:</h4><p>{{ exercice.variablesText }}</p></div>
      <div class="schema" *ngIf="exercice.schemaUrl"><img [src]="exercice.schemaUrl" alt="Schéma de l'exercice" /></div>
      
      <div class="tags-section">
        <div class="tag-group" *ngIf="niveauTags.length > 0">
          <h4>Niveau:</h4>
          <div class="tags-container"><span class="tag tag--niveau" *ngFor="let tag of niveauTags" [style.background-color]="tag.color || '#34A853'">{{ tag.level ? '★'.repeat(tag.level) : tag.label }}</span></div>
        </div>
        <div class="tag-group" *ngIf="tempsTags?.length">
          <h4>Temps moyen:</h4>
          <div class="tags-container"><span class="tag tag--temps" *ngFor="let tag of tempsTags" [style.background-color]="tag.color || '#9C27B0'">{{ tag.label }}</span></div>
        </div>
        <div class="tag-group" *ngIf="formatTags?.length">
          <h4>Format:</h4>
          <div class="tags-container"><span class="tag tag--format" *ngFor="let tag of formatTags" [style.background-color]="tag.color || '#00BCD4'">{{ tag.label }}</span></div>
        </div>
      </div>
      
      <div class="notes-panel" *ngIf="notes"><h4>Notes pour cet entraînement :</h4><p>{{ notes }}</p></div>
    </div>

    <!-- PIED DE CARTE -->
    <div class="meta-info">
      <span class="created-at" *ngIf="exercice.createdAt">Créé le {{ exercice.createdAt | date:'dd/MM/yyyy' }}</span>
    </div>
  </div>
</div>