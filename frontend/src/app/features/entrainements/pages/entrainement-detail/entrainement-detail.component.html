<div class="detail-container">
  <ng-container *ngIf="entrainement; else loadingOrError">
    <mat-card class="training-card">
      <mat-card-header>
        <mat-card-title>{{ entrainement.titre }}</mat-card-title>
        <mat-card-subtitle>{{ formatDate(entrainement.date) }}</mat-card-subtitle>
        <div class="header-actions">
          <button mat-icon-button (click)="modifierEntrainement()" matTooltip="Modifier l'entraînement">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button (click)="retourListe()" matTooltip="Retour à la liste">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="training-meta">
          <div class="meta-item block-indicators">
            <mat-icon>layers</mat-icon>
            <span class="block-chip echauffement" *ngIf="entrainement.echauffement">Échauffement</span>
            <span class="block-chip exercices" *ngIf="entrainement.exercices && entrainement.exercices.length > 0">Exercices</span>
            <span class="block-chip situation" *ngIf="entrainement.situationMatch">Match</span>
          </div>
          <div class="meta-item duration-highlight">
            <mat-icon>timer</mat-icon>
            <span>{{ calculateTotalDuration() }}</span>
          </div>
          <div class="meta-item tags" *ngIf="entrainement.tags && entrainement.tags.length > 0">
            <mat-icon>label</mat-icon>
            <mat-chip-listbox>
              <mat-chip *ngFor="let tag of entrainement.tags" [style.background-color]="tag.color || '#e0e0e0'" selected>{{ tag.label }}</mat-chip>
            </mat-chip-listbox>
          </div>
        </div>

        <mat-accordion multi="true">
          <!-- 1. Échauffement -->
          <mat-expansion-panel *ngIf="entrainement.echauffement" [expanded]="true">
            <mat-expansion-panel-header class="echauffement-header">
              <mat-panel-title>
                <mat-icon>whatshot</mat-icon>
                Échauffement: {{ entrainement.echauffement.nom }}
              </mat-panel-title>
              <mat-panel-description>
                {{ getTotalEchauffementLabel() }}
              </mat-panel-description>
            </mat-expansion-panel-header>
            <app-echauffement-view [echauffement]="entrainement.echauffement"></app-echauffement-view>
          </mat-expansion-panel>

          <!-- 2. Exercices -->
          <mat-expansion-panel *ngIf="entrainement.exercices && entrainement.exercices.length > 0" [expanded]="true">
            <mat-expansion-panel-header class="exercices-header">
              <mat-panel-title>
                <mat-icon>fitness_center</mat-icon>
                Exercices ({{ entrainement.exercices.length }})
              </mat-panel-title>
            </mat-expansion-panel-header>
            <mat-list role="list">
              <ng-container *ngFor="let exerciceEntrainement of entrainement.exercices; let i = index">
                <mat-list-item *ngIf="exerciceEntrainement.exercice" role="listitem">
                  <div class="exercice-item-content">
                    <div class="exercice-title">{{ i + 1 }}. {{ exerciceEntrainement.exercice.nom }}</div>
                    <div class="exercice-meta">
                      <mat-icon>schedule</mat-icon> {{ formatDuree(exerciceEntrainement.duree) }}
                    </div>
                    <app-exercice-view [exercice]="exerciceEntrainement.exercice" [isSummary]="true"></app-exercice-view>
                  </div>
                  <button mat-icon-button (click)="openExerciceView(exerciceEntrainement.exercice)" matTooltip="Voir le détail de l'exercice">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </mat-list-item>
              </ng-container>
            </mat-list>
          </mat-expansion-panel>

          <!-- 3. Situation/Match -->
          <mat-expansion-panel *ngIf="entrainement.situationMatch" [expanded]="true">
            <mat-expansion-panel-header class="situation-header">
              <mat-panel-title>
                <mat-icon>sports_soccer</mat-icon>
                Match: {{ entrainement.situationMatch.nom || entrainement.situationMatch.type }}
              </mat-panel-title>
              <mat-panel-description>
                {{ entrainement.situationMatch.temps }}
              </mat-panel-description>
            </mat-expansion-panel-header>
            <app-situationmatch-view [situationMatch]="entrainement.situationMatch"></app-situationmatch-view>
          </mat-expansion-panel>
        </mat-accordion>

      </mat-card-content>
    </mat-card>
  </ng-container>

  <ng-template #loadingOrError>
    <div class="loading-container" *ngIf="loading; else errorTemplate">
      <mat-spinner></mat-spinner>
      <p>Chargement de l'entraînement...</p>
    </div>
    <ng-template #errorTemplate>
      <div class="error-container">
        <p>{{ error || 'Erreur inconnue' }}</p>
        <button mat-stroked-button (click)="loadEntrainement(entrainementId!)">Réessayer</button>
      </div>
    </ng-template>
  </ng-template>
</div>

