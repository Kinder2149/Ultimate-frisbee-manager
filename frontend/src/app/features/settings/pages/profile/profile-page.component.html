<mat-card>
  <mat-card-header>
    <mat-icon>account_circle</mat-icon>
    <div class="title">Mon profil</div>
  </mat-card-header>
  <mat-card-content>
    <div *ngIf="loading" class="loading-indicator">
      <mat-progress-spinner diameter="32" mode="indeterminate"></mat-progress-spinner>
      <span>Chargement du profil...</span>
    </div>

    <div *ngIf="!loading" class="profile-container">

      <!-- COLONNE GAUCHE: FORMULAIRE -->
      <div class="profile-form-container">
        <form [formGroup]="form" (ngSubmit)="submit()">
          <mat-card class="profile-section-card">
            <mat-card-header>
              <mat-card-title>Informations personnelles</mat-card-title>
              <mat-card-subtitle>Gérez vos informations publiques</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content class="form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Prénom</mat-label>
                <input matInput formControlName="prenom" placeholder="Votre prénom">
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Nom</mat-label>
                <input matInput formControlName="nom" placeholder="Votre nom">
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" type="email" placeholder="nom@domaine.com">
                <mat-error *ngIf="form.get('email')?.hasError('email')">Email invalide</mat-error>
                <mat-error *ngIf="form.get('email')?.hasError('required')">Email requis</mat-error>
              </mat-form-field>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="loading">Réinitialiser</button>
              <button mat-flat-button color="primary" type="submit" [disabled]="loading || form.invalid">
                <mat-icon>save</mat-icon>
                Enregistrer les informations
              </button>
            </mat-card-actions>
          </mat-card>
        </form>

        <!-- FORMULAIRE QUESTION DE SECURITE -->
        <form [formGroup]="securityForm" (ngSubmit)="setSecurityQuestion()">
          <mat-card class="profile-section-card">
            <mat-card-header>
              <mat-card-title>Question de sécurité</mat-card-title>
              <mat-card-subtitle>Utilisée pour réinitialiser votre mot de passe</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content class="form-grid">

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Votre question secrète</mat-label>
                <input matInput formControlName="securityQuestion" placeholder="Ex: Le nom de mon premier animal">
                <mat-error *ngIf="securityForm.get('securityQuestion')?.hasError('required')">La question est requise</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Réponse secrète</mat-label>
                <input matInput formControlName="securityAnswer" placeholder="La réponse est sensible à la casse">
                <mat-hint>La réponse sera stockée de manière sécurisée.</mat-hint>
                <mat-error *ngIf="securityForm.get('securityAnswer')?.hasError('required')">La réponse est requise</mat-error>
              </mat-form-field>

            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-flat-button color="primary" type="submit" [disabled]="loading || securityForm.invalid">
                <mat-icon>save</mat-icon>
                Enregistrer la question
              </button>
            </mat-card-actions>
          </mat-card>
        </form>

        <!-- FORMULAIRE CHANGEMENT DE MOT DE PASSE -->
        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
          <mat-card class="profile-section-card">
            <mat-card-header>
              <mat-card-title>Sécurité</mat-card-title>
              <mat-card-subtitle>Changer votre mot de passe</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content class="form-grid">


              <mat-form-field appearance="outline">
                <mat-label>Nouveau mot de passe</mat-label>
                <input matInput [type]="hideNewPassword ? 'password' : 'text'" formControlName="newPassword">
                <button mat-icon-button matSuffix (click)="hideNewPassword = !hideNewPassword" type="button">
                  <mat-icon>{{hideNewPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                </button>
                <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('required')">Nouveau mot de passe requis</mat-error>
                <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('minlength')">Au moins 6 caractères</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Confirmer le mot de passe</mat-label>
                <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword">
                <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
                  <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                </button>
                <mat-error *ngIf="passwordForm.get('confirmPassword')?.hasError('required')">Confirmation requise</mat-error>
                <mat-error *ngIf="passwordForm.hasError('passwordMismatch') && passwordForm.get('confirmPassword')?.touched">
                  Les mots de passe ne correspondent pas
                </mat-error>
              </mat-form-field>

            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-flat-button color="primary" type="submit" [disabled]="loading || passwordForm.invalid">
                <mat-icon>lock_reset</mat-icon>
                Changer le mot de passe
              </button>
            </mat-card-actions>
          </mat-card>
        </form>
      </div>

      <!-- COLONNE DROITE: AVATAR -->
      <div class="profile-avatar-container">
        <mat-card class="profile-section-card">
          <mat-card-header>
            <mat-card-title>Avatar</mat-card-title>
            <mat-card-subtitle>Personnalisez votre photo de profil</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content class="avatar-content">
            <img [src]="(user$ | async)?.iconUrl | absoluteUrl" alt="Avatar actuel" class="avatar-preview" *ngIf="(user$ | async)?.iconUrl">
            <div class="avatar-placeholder" *ngIf="!(user$ | async)?.iconUrl">
              <mat-icon>person</mat-icon>
            </div>

            <div class="upload-actions">
              <input type="file" accept="image/*" (change)="onFileSelected($event)" #fileInput hidden>
              <button mat-stroked-button type="button" (click)="fileInput.click()">
                <mat-icon>attach_file</mat-icon>
                Choisir un fichier
              </button>
              <span *ngIf="selectedFile" class="selected-file-name">{{ selectedFile.name }}</span>
            </div>

          </mat-card-content>
          <mat-card-actions align="end">
            <button mat-flat-button color="primary" (click)="uploadIcon()" [disabled]="!selectedFile || loading">
              <mat-icon>upload</mat-icon>
              Mettre à jour l'avatar
            </button>
          </mat-card-actions>
        </mat-card>
      </div>

    </div>
  </mat-card-content>
</mat-card>
