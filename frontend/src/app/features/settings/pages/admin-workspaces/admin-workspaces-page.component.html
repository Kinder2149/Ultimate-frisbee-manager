<div class="admin-workspaces-page">
  <!-- Bandeau ADMIN global : gestion de toutes les bases -->
  <header class="page-header admin-theme">
    <div class="page-header__icon">
      <mat-icon>admin_panel_settings</mat-icon>
    </div>
    <div class="page-header__content">
      <h1 class="page-title">Administration globale des workspaces</h1>
      <p class="page-subtitle">
        Gérez toutes les bases (workspaces) et leurs membres. Cette vue est réservée aux administrateurs
        globaux et ne concerne pas l'administration locale d'un seul workspace (OWNER).
      </p>
    </div>
  </header>

  <!-- Section création d'une nouvelle base -->
  <section class="create-section">
    <mat-card class="create-card">
      <mat-card-header>
        <div mat-card-avatar class="create-card__avatar">
          <mat-icon>add_business</mat-icon>
        </div>
        <mat-card-title>Créer une nouvelle base</mat-card-title>
        <mat-card-subtitle>
          Créez un nouveau workspace (club / projet). Vous pourrez ensuite y ajouter des utilisateurs et définir
          leurs rôles locaux.
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="create-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nom de la base</mat-label>
            <input matInput [(ngModel)]="newWorkspaceName" placeholder="Ex. Club U17, Section mixte, Projet test" />
          </mat-form-field>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button
          mat-raised-button
          color="primary"
          (click)="createWorkspace()"
          [disabled]="creating || loading || !newWorkspaceName.trim()"
        >
          <mat-icon>add</mat-icon>
          Créer la base
        </button>
      </mat-card-actions>
    </mat-card>
  </section>

  <!-- Contenu principal : liste des bases + panneau latéral membres -->
  <section class="content">
    <!-- Colonne gauche : liste des workspaces -->
    <div class="workspaces-panel">
      <div class="panel-header">
        <h2 class="panel-title">Workspaces existants</h2>
        <span class="panel-counter" *ngIf="workspaces?.length">{{ workspaces.length }} base(s)</span>
      </div>

      <div class="panel-filters" *ngIf="workspaces?.length">
        <mat-form-field appearance="outline" class="workspace-filter-field">
          <mat-label>Rechercher un workspace</mat-label>
          <input
            matInput
            [(ngModel)]="workspaceFilter"
            placeholder="Nom ou ID du workspace"
          />
        </mat-form-field>
      </div>

      <!-- Barre d'outils pour le workspace sélectionné -->
      <div class="workspaces-toolbar" *ngIf="workspaces?.length">
        <div class="workspaces-toolbar__info">
          <ng-container *ngIf="selectedWorkspace as ws; else noWorkspaceSelectedToolbar">
            <div class="workspaces-toolbar__title">
              <span class="label">Base sélectionnée :</span>
              <span class="name">{{ ws.name }}</span>
            </div>
            <div class="workspaces-toolbar__subtitle">
              ID : {{ ws.id }}
            </div>
          </ng-container>
          <ng-template #noWorkspaceSelectedToolbar>
            <div class="workspaces-toolbar__title">
              <span class="label">Aucune base sélectionnée</span>
            </div>
            <div class="workspaces-toolbar__subtitle">
              Cliquez sur une ligne dans la liste pour afficher les actions et gérer les membres.
            </div>
          </ng-template>
        </div>

        <div class="workspaces-toolbar__actions" *ngIf="selectedWorkspace as ws">
          <button
            mat-stroked-button
            color="primary"
            class="toolbar-button"
            (click)="switchToWorkspace(ws)"
            [disabled]="loading || isCurrentWorkspace(ws)"
          >
            <mat-icon>open_in_new</mat-icon>
            Basculer sur cette base
          </button>

          <button
            mat-stroked-button
            color="primary"
            class="toolbar-button"
            (click)="startEdit(ws)"
            [disabled]="savingWorkspace || deletingWorkspaceId === ws.id || duplicatingWorkspaceId === ws.id || loading"
          >
            <mat-icon>edit</mat-icon>
            Renommer
          </button>

          <button
            mat-stroked-button
            color="primary"
            class="toolbar-button"
            (click)="duplicateWorkspace(ws)"
            [disabled]="duplicatingWorkspaceId === ws.id || deletingWorkspaceId === ws.id || savingWorkspace || loading"
          >
            <mat-icon>content_copy</mat-icon>
            Dupliquer
          </button>

          <button
            mat-stroked-button
            color="warn"
            class="toolbar-button toolbar-button--danger"
            (click)="deleteWorkspace(ws)"
            *ngIf="(ws.name || '').trim().toUpperCase() !== 'BASE'"
            [disabled]="deletingWorkspaceId === ws.id || savingWorkspace || duplicatingWorkspaceId === ws.id || loading"
          >
            <mat-icon>delete</mat-icon>
            Supprimer
          </button>
        </div>
      </div>

      <div class="table-wrapper mat-elevation-z2" *ngIf="workspaces?.length; else emptyWorkspaces">
        <table mat-table [dataSource]="filteredWorkspaces" class="workspaces-table">
          <!-- Nom de la base -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Nom du workspace</th>
            <td mat-cell *matCellDef="let ws" [class.is-selected]="selectedWorkspace?.id === ws.id">
              <div class="ws-name-cell">
                <mat-icon class="ws-icon">storage</mat-icon>
                <div class="ws-name-cell__content">
                  <span *ngIf="editingWorkspace?.id !== ws.id" class="ws-name">{{ ws.name }}</span>
                  <mat-form-field *ngIf="editingWorkspace?.id === ws.id" appearance="outline" class="ws-name-edit">
                    <mat-label>Nom du workspace</mat-label>
                    <input matInput [(ngModel)]="editName" />
                  </mat-form-field>
                  <span *ngIf="isCurrentWorkspace(ws)" class="ws-current-chip">Workspace courant</span>
                  <span class="ws-id" *ngIf="editingWorkspace?.id !== ws.id">ID : {{ ws.id }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Nombre de membres -->
          <ng-container matColumnDef="contents">
            <th mat-header-cell *matHeaderCellDef>Contenus</th>
            <td mat-cell *matCellDef="let ws">
              <div class="contents-cell">
                <span class="contents-main">
                  {{ ws.exercicesCount || 0 }} exos / {{ ws.entrainementsCount || 0 }} entr.
                </span>
                <span class="contents-secondary">
                  {{ ws.echauffementsCount || 0 }} éch. / {{ ws.situationsCount || 0 }} sit.
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Nombre de membres -->
          <ng-container matColumnDef="membersCount">
            <th mat-header-cell *matHeaderCellDef>Membres</th>
            <td mat-cell *matCellDef="let ws">
              <button
                mat-stroked-button
                color="primary"
                class="members-button"
                (click)="selectWorkspace(ws)"
              >
                <mat-icon>group</mat-icon>
                {{ ws.membersCount || 0 }} membre(s)
              </button>
            </td>
          </ng-container>

          <!-- Date de création -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Créée le</th>
            <td mat-cell *matCellDef="let ws">{{ ws.createdAt | date: 'mediumDate' }}</td>
          </ng-container>

          <!-- Actions -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-header">Actions</th>
            <td mat-cell *matCellDef="let ws" class="actions-cell">
              <button
                mat-icon-button
                [matMenuTriggerFor]="workspaceMenu"
                (click)="$event.stopPropagation()"
                aria-label="Actions sur le workspace"
              >
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #workspaceMenu="matMenu">
                <!-- Menu en mode normal -->
                <ng-container *ngIf="editingWorkspace?.id !== ws.id; else editMenu">
                  <button mat-menu-item (click)="selectWorkspace(ws)">
                    <mat-icon>group</mat-icon>
                    <span>Gérer les membres</span>
                  </button>
                  <button mat-menu-item (click)="switchToWorkspace(ws)" [disabled]="loading || isCurrentWorkspace(ws)">
                    <mat-icon>open_in_new</mat-icon>
                    <span>Basculer sur cette base</span>
                  </button>
                  <button
                    mat-menu-item
                    (click)="startEdit(ws)"
                    [disabled]="savingWorkspace || deletingWorkspaceId === ws.id || duplicatingWorkspaceId === ws.id || loading"
                  >
                    <mat-icon>edit</mat-icon>
                    <span>Renommer</span>
                  </button>
                  <button
                    mat-menu-item
                    (click)="duplicateWorkspace(ws)"
                    [disabled]="duplicatingWorkspaceId === ws.id || deletingWorkspaceId === ws.id || savingWorkspace || loading"
                  >
                    <mat-icon>content_copy</mat-icon>
                    <span>Dupliquer</span>
                  </button>
                  <button
                    mat-menu-item
                    (click)="deleteWorkspace(ws)"
                    *ngIf="(ws.name || '').trim().toUpperCase() !== 'BASE'"
                    [disabled]="deletingWorkspaceId === ws.id || savingWorkspace || duplicatingWorkspaceId === ws.id || loading"
                  >
                    <mat-icon>delete</mat-icon>
                    <span>Supprimer</span>
                  </button>
                </ng-container>

                <!-- Menu en mode édition du nom -->
                <ng-template #editMenu>
                  <button mat-menu-item (click)="saveEdit()" [disabled]="savingWorkspace || deletingWorkspaceId === ws.id || loading">
                    <mat-icon>check</mat-icon>
                    <span>Enregistrer</span>
                  </button>
                  <button mat-menu-item (click)="cancelEdit()" [disabled]="savingWorkspace || deletingWorkspaceId === ws.id || loading">
                    <mat-icon>close</mat-icon>
                    <span>Annuler</span>
                  </button>
                </ng-template>
              </mat-menu>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns;"
            [class.is-selected]="selectedWorkspace?.id === row.id"
            (click)="selectWorkspace(row)"
          ></tr>
        </table>
      </div>

      <ng-template #emptyWorkspaces>
        <div class="empty-state">
          <mat-icon>dashboard_customize</mat-icon>
          <div class="empty-state__text">
            <h3>Aucune base configurée pour le moment</h3>
            <p>
              Utilisez le formulaire ci-dessus pour créer votre première base de travail.
            </p>
          </div>
        </div>
      </ng-template>
    </div>

    <!-- Colonne droite : panneau membres du workspace sélectionné -->
    <aside class="workspace-users" *ngIf="selectedWorkspace as ws; else noWorkspaceSelected">
      <mat-card class="workspace-users-card">
        <mat-card-header>
          <div mat-card-avatar class="workspace-users-card__avatar">
            <mat-icon>group</mat-icon>
          </div>
          <mat-card-title>Membres de "{{ ws.name }}"</mat-card-title>
          <mat-card-subtitle>
            Affectez des utilisateurs à cette base et définissez leur rôle local (OWNER / USER).
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="workspace-users__meta">
            <span>
              <mat-icon>event</mat-icon>
              Créée le {{ ws.createdAt | date: 'mediumDate' }}
            </span>
            <span>
              <mat-icon>group</mat-icon>
              {{ ws.membersCount || 0 }} membre(s)
            </span>
          </div>

          <p class="workspace-users__hint">
            <strong>OWNER</strong> : admin local de ce workspace uniquement.
            <strong>USER</strong> : utilisateur simple de cette base.
            Les permissions globales (ADMIN) restent gérées au niveau des utilisateurs.
          </p>

          <mat-list class="workspace-users__list">
            <mat-list-item *ngFor="let user of allUsers" class="workspace-users__item">
              <div class="workspace-users__user">
                <mat-checkbox
                  [checked]="isUserInWorkspace(user.id)"
                  (change)="toggleUserInWorkspace(user.id, $event)"
                >
                  <span class="user-email">{{ user.email }}</span>
                  <span class="user-name" *ngIf="user.prenom || user.nom">
                    ({{ user.prenom }} {{ user.nom }})
                  </span>
                </mat-checkbox>
              </div>

              <div class="workspace-users__role" *ngIf="isUserInWorkspace(user.id)">
                <mat-form-field appearance="outline" class="role-select">
                  <mat-label>Rôle dans cette base</mat-label>
                  <mat-select
                    [value]="getWorkspaceUserRole(user.id)"
                    (selectionChange)="setUserRole(user.id, $event.value)"
                  >
                    <mat-option value="OWNER">Owner (admin local du workspace)</mat-option>
                    <mat-option value="USER">Utilisateur du workspace</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </mat-list-item>
          </mat-list>
        </mat-card-content>

        <mat-card-actions align="end" class="workspace-users__actions">
          <button
            mat-raised-button
            color="primary"
            (click)="saveWorkspaceUsers()"
            [disabled]="savingUsers || !workspaceUsers.length"
          >
            <mat-icon>save</mat-icon>
            Enregistrer les membres de la base
          </button>
        </mat-card-actions>
      </mat-card>
    </aside>

    <ng-template #noWorkspaceSelected>
      <aside class="workspace-users workspace-users--placeholder">
        <mat-card class="workspace-users-card placeholder-card">
          <mat-card-content>
            <div class="placeholder-card__content">
              <mat-icon>info</mat-icon>
              <div>
                <h3>Sélectionnez un workspace</h3>
                <p>
                  Choisissez une base dans la liste de gauche pour afficher et modifier la liste des membres associés.
                </p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </aside>
    </ng-template>
  </section>
</div>
