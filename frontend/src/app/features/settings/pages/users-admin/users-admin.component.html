<mat-card>
  <mat-card-header>
    <mat-icon>supervisor_account</mat-icon>
    <div class="title">Gestion des utilisateurs</div>
  </mat-card-header>
  <mat-card-content>
    <!-- Create new user -->
    <div class="new-user-form">
      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput type="email" [(ngModel)]="newUser.email" placeholder="email@domaine.com" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Mot de passe</mat-label>
        <input matInput type="password" [(ngModel)]="newUser.password" placeholder="min 6 caractères" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Prénom</mat-label>
        <input matInput [(ngModel)]="newUser.prenom" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nom</mat-label>
        <input matInput [(ngModel)]="newUser.nom" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Rôle</mat-label>
        <mat-select [(ngModel)]="newUser.role">
          <mat-option value="user">Utilisateur</mat-option>
          <mat-option value="admin">Administrateur</mat-option>
        </mat-select>
      </mat-form-field>

      <div style="display:flex; align-items:center; gap:8px;">
        <mat-slide-toggle [(ngModel)]="newUser.isActive">Actif</mat-slide-toggle>
        <button mat-raised-button color="primary" (click)="createUser()" [disabled]="creating">
          <mat-icon style="margin-right:6px;">person_add</mat-icon>
          Créer un utilisateur
        </button>
        <mat-progress-spinner *ngIf="creating" diameter="22" mode="indeterminate"></mat-progress-spinner>
      </div>
    </div>

    <div *ngIf="loading" style="display:flex; align-items:center; gap:8px;">
      <mat-progress-spinner diameter="22" mode="indeterminate"></mat-progress-spinner>
      <span>Chargement des utilisateurs...</span>
    </div>

    <div *ngIf="!loading">
      <table mat-table [dataSource]="users" class="users-table" style="width:100%;">
        <!-- Avatar -->
        <ng-container matColumnDef="avatar">
          <th mat-header-cell *matHeaderCellDef> Avatar </th>
          <td mat-cell *matCellDef="let u">
            <img *ngIf="u.iconUrl" [src]="u.iconUrl" alt="avatar" class="avatar" />
            <mat-icon *ngIf="!u.iconUrl">account_circle</mat-icon>
          </td>
        </ng-container>

        <!-- Name -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Nom </th>
          <td mat-cell *matCellDef="let u"> {{u.prenom || ''}} {{u.nom || ''}} </td>
        </ng-container>

        <!-- Email -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef> Email </th>
          <td mat-cell *matCellDef="let u"> {{u.email}} </td>
        </ng-container>

        <!-- Role -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef> Rôle </th>
          <td mat-cell *matCellDef="let u">
            <mat-select [(ngModel)]="u.role" [disabled]="u._saving" style="min-width: 140px;">
              <mat-option value="user">Utilisateur</mat-option>
              <mat-option value="admin">Administrateur</mat-option>
            </mat-select>
          </td>
        </ng-container>

        <!-- Active -->
        <ng-container matColumnDef="active">
          <th mat-header-cell *matHeaderCellDef> Actif </th>
          <td mat-cell *matCellDef="let u">
            <mat-slide-toggle [(ngModel)]="u.isActive" [disabled]="u._saving"></mat-slide-toggle>
          </td>
        </ng-container>

        <!-- Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let u">
            <button mat-stroked-button color="primary" (click)="saveUser(u)" [disabled]="u._saving">
              <mat-icon style="margin-right:6px;">save</mat-icon>
              Enregistrer
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>
  </mat-card-content>
</mat-card>
