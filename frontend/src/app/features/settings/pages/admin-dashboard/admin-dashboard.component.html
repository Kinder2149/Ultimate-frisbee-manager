<div class="admin-container">
  <h1 class="mat-h1">Tableau de bord d'administration</h1>

  <div *ngIf="loading && !error" class="loading-spinner">
    <mat-spinner></mat-spinner>
    <p>Chargement des données...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <mat-icon color="warn">error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-button color="primary" (click)="loadOverview()">
      <mat-icon>refresh</mat-icon>
      Réessayer
    </button>
  </div>

  <mat-tab-group [(selectedIndex)]="activeTab">
    <!-- Onglet Aperçu des données -->
    <mat-tab label="Aperçu des données">
      <div class="tab-content">
        <div *ngIf="!loading && !error" class="overview-grid">
          <!-- Cartes de statistiques -->
          <mat-card class="stat-card">
            <mat-card-header>
              <div mat-card-avatar class="stat-avatar primary">
                <mat-icon>fitness_center</mat-icon>
              </div>
              <mat-card-title>{{ counts.exercices || 0 }}</mat-card-title>
              <mat-card-subtitle>Exercices</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-button color="primary" (click)="goToExplorer('exercices')">Voir tout</button>
            </mat-card-actions>
          </mat-card>
          
          <mat-card class="stat-card">
            <mat-card-header>
              <div mat-card-avatar class="stat-avatar accent">
                <mat-icon>sports_soccer</mat-icon>
              </div>
              <mat-card-title>{{ counts.entrainements || 0 }}</mat-card-title>
              <mat-card-subtitle>Entraînements</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-button color="primary" (click)="goToExplorer('entrainements')">Voir tout</button>
            </mat-card-actions>
          </mat-card>
          
          <mat-card class="stat-card">
            <mat-card-header>
              <div mat-card-avatar class="stat-avatar warn">
                <mat-icon>directions_run</mat-icon>
              </div>
              <mat-card-title>{{ counts.echauffements || 0 }}</mat-card-title>
              <mat-card-subtitle>Échauffements</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-button color="primary" (click)="goToExplorer('echauffements')">Voir tout</button>
            </mat-card-actions>
          </mat-card>
          
          <mat-card class="stat-card">
            <mat-card-header>
              <div mat-card-avatar class="stat-avatar primary">
                <mat-icon>sports</mat-icon>
              </div>
              <mat-card-title>{{ counts.situations || 0 }}</mat-card-title>
              <mat-card-subtitle>Situations</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-button color="primary" (click)="goToExplorer('situations')">Voir tout</button>
            </mat-card-actions>
          </mat-card>
          
          <mat-card class="stat-card">
            <mat-card-header>
              <div mat-card-avatar class="stat-avatar accent">
                <mat-icon>label</mat-icon>
              </div>
              <mat-card-title>{{ counts.tags || 0 }}</mat-card-title>
              <mat-card-subtitle>Tags</mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions align="end">
              <button mat-button color="primary" (click)="goToExplorer('tags')">Voir tout</button>
            </mat-card-actions>
          </mat-card>
          
          <mat-card class="stat-card">
            <mat-card-header>
              <div mat-card-avatar class="stat-avatar warn">
                <mat-icon>people</mat-icon>
              </div>
              <mat-card-title>{{ counts.users || 0 }}</mat-card-title>
              <mat-card-subtitle>Utilisateurs</mat-card-subtitle>
            </mat-card-header>
          </mat-card>
        </div>

        <!-- Bouton global pour l'explorateur de données -->
<div class="global-actions">
            <a mat-raised-button color="primary" class="data-explorer-button" routerLink="/parametres/admin/explorer">
              <mat-icon>travel_explore</mat-icon>
              Explorer toutes les données
            </a>
          </div>

      </div>
    </mat-tab>

    <!-- Onglet Gestion des utilisateurs -->
    <mat-tab label="Gestion des utilisateurs">
    <div class="tab-content">
    <div class="user-management">
    <div class="user-form">
    <h2>Créer un nouvel utilisateur</h2>
    <form (ngSubmit)="createUser()" #userForm="ngForm">
    <div class="form-row">
    <mat-form-field appearance="outline">
    <mat-label>Email</mat-label>
    <input matInput type="email" [(ngModel)]="newUser.email" name="email" required>
    <mat-error>L'email est obligatoire</mat-error>
    </mat-form-field>
    
    <mat-form-field appearance="outline">
    <mat-label>Mot de passe</mat-label>
    <input matInput [type]="hidePassword ? 'password' : 'text'" [(ngModel)]="newUser.password" name="password" required>
    <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
    <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
    </button>
    <mat-error>Le mot de passe est obligatoire</mat-error>
    </mat-form-field>
    </div>
    
    <div class="form-row">
    <mat-form-field appearance="outline">
    <mat-label>Prénom</mat-label>
    <input matInput [(ngModel)]="newUser.prenom" name="prenom">
    </mat-form-field>
    
    <mat-form-field appearance="outline">
    <mat-label>Nom</mat-label>
    <input matInput [(ngModel)]="newUser.nom" name="nom">
    </mat-form-field>
    </div>
    
    <div class="form-row">
    <mat-form-field appearance="outline">
    <mat-label>Rôle</mat-label>
    <mat-select [(ngModel)]="newUser.role" name="role">
    <mat-option value="user">Utilisateur</mat-option>
    <mat-option value="admin">Administrateur</mat-option>
    </mat-select>
    </mat-form-field>
    
    <mat-checkbox [(ngModel)]="newUser.isActive" name="isActive">
    Compte actif
    </mat-checkbox>
    </div>
    
    <div class="form-actions">
    <button 
    mat-raised-button 
    color="primary" 
    type="submit" 
    [disabled]="!userForm.form.valid || creating">
    <span *ngIf="!creating">Créer l'utilisateur</span>
    <mat-spinner *ngIf="creating" diameter="24"></mat-spinner>
    </button>
    </div>
    </form>
    </div>

    <div class="user-list">
    <h2>Liste des utilisateurs</h2>
    <div class="table-container">
    <table mat-table [dataSource]="usersDS" matSort class="mat-elevation-z1">
    <ng-container matColumnDef="email">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
    <td mat-cell *matCellDef="let user">{{user.email}}</td>
    </ng-container>
    
    <ng-container matColumnDef="nomComplet">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Nom</th>
    <td mat-cell *matCellDef="let user">{{user.prenom}} {{user.nom}}</td>
    </ng-container>
    
    <ng-container matColumnDef="role">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Rôle</th>
    <td mat-cell *matCellDef="let user">
    <mat-form-field floatLabel="always" appearance="fill">
    <mat-select [(ngModel)]="user.role" (selectionChange)="updateUser(user)" [disabled]="user._saving">
    <mat-option value="admin">Administrateur</mat-option>
    <mat-option value="user">Utilisateur</mat-option>
    </mat-select>
    </mat-form-field>
    </td>
    </ng-container>
    
    <ng-container matColumnDef="isActive">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Actif</th>
    <td mat-cell *matCellDef="let user">
    <mat-slide-toggle 
    [(ngModel)]="user.isActive" 
    (change)="updateUser(user)" 
    [disabled]="user._saving"
    color="primary">
    {{ user.isActive ? 'Oui' : 'Non' }}
    </mat-slide-toggle>
    </td>
    </ng-container>
    
    <ng-container matColumnDef="createdAt">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Inscrit le</th>
    <td mat-cell *matCellDef="let user">{{user.createdAt | date:'dd/MM/yyyy'}}</td>
    </ng-container>
    
    <tr mat-header-row *matHeaderRowDef="['email', 'nomComplet', 'role', 'isActive', 'createdAt']"></tr>
    <tr mat-row *matRowDef="let row; columns: ['email', 'nomComplet', 'role', 'isActive', 'createdAt'];"></tr>
    </table>
    
    <mat-paginator 
    [pageSizeOptions]="[5, 10, 25, 100]" 
    aria-label="Sélectionner la page"
    #userPaginator>
    </mat-paginator>
    </div>
    </div>
    </div>
    </div>
    </mat-tab>
  </mat-tab-group>
</div>
