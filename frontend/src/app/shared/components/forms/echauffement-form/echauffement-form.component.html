<div class="echauffement-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        {{ isEditMode ? 'Modifier l\'échauffement' : 'Créer un nouvel échauffement' }}
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="echauffementForm" (ngSubmit)="onSubmit()">
        
        <!-- Informations générales -->
        <div class="section">
          <h3>Informations générales</h3>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nom de l'échauffement</mat-label>
            <input matInput formControlName="nom" placeholder="Ex: Échauffement technique">
            <mat-error *ngIf="echauffementForm.get('nom')?.invalid && echauffementForm.get('nom')?.touched">
              {{ getErrorMessage('nom') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" 
                      placeholder="Description générale de l'échauffement..." 
                      rows="3"></textarea>
            <mat-error *ngIf="echauffementForm.get('description')?.invalid && echauffementForm.get('description')?.touched">
              {{ getErrorMessage('description') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Image globale -->
        <mat-divider></mat-divider>
        <div class="section">
          <h3>Illustration</h3>
          <div *ngIf="!(imagePreview || echauffementForm.get('imageUrl')?.value)" class="image-placeholder" style="margin-bottom:8px; display:flex; align-items:center; gap:8px; color:#777;">
            <mat-icon>image</mat-icon>
            <span>Ajouter une image</span>
          </div>
          <div class="media-grid" *ngIf="imagePreview || echauffementForm.get('imageUrl')?.value" style="display:flex; gap:12px; flex-wrap:wrap;">
            <div class="media-item" style="width:280px; max-width:100%;">
              <img [src]="imagePreview || mediaUrl(echauffementForm.get('imageUrl')?.value)" alt="Prévisualisation de l'image" style="width:100%; height:180px; object-fit:cover; border-radius:6px; border:1px solid #eaeaea;" />
              <div class="media-caption" style="font-size:12px; color:#666; margin-top:4px;">Prévisualisation</div>
            </div>
          </div>
          <input 
            type="file" 
            accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
            (change)="onImageSelected($event)"
            [disabled]="uploading"
            style="margin:8px 0;"
          />
          <div style="display:flex; gap:8px; margin-bottom:6px;">
            <button type="button" mat-stroked-button color="primary" (click)="uploadSelectedImage()" [disabled]="!selectedImageFile || uploading">
              <mat-icon *ngIf="!uploading">cloud_upload</mat-icon>
              <mat-icon *ngIf="uploading">hourglass_empty</mat-icon>
              Uploader
            </button>
            <button type="button" mat-button (click)="selectedImageFile=null; imagePreview=null;" [disabled]="!selectedImageFile || uploading">Annuler</button>
          </div>
          <small class="form-text text-muted">PNG, JPG, GIF, WEBP · max 5 Mo</small>
          <div *ngIf="uploading" style="margin-top:6px; display:flex; align-items:center; gap:8px; color:#555;">
            <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
            <span>Upload en cours…</span>
          </div>
          <div class="form-group" style="margin-top:10px;">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>URL de l'image</mat-label>
              <input matInput type="text" formControlName="imageUrl" placeholder="https://exemple.com/image.jpg">
            </mat-form-field>
          </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Blocs d'échauffement -->
        <div class="section">
          <div class="section-header">
            <h3>Blocs d'échauffement</h3>
            <button type="button" mat-raised-button color="primary" (click)="ajouterBloc()">
              <mat-icon>add</mat-icon>
              Ajouter un bloc
            </button>
          </div>

          <!-- État vide: aucun bloc -->
          <div class="empty-state" *ngIf="blocsFormArray.length === 0">
            <p>Aucun bloc pour l'instant.</p>
            <button type="button" mat-stroked-button color="primary" (click)="ajouterBloc()">
              <mat-icon>add</mat-icon>
              Ajouter le premier bloc
            </button>
          </div>

          <div formArrayName="blocs" class="blocs-container">
            <div *ngFor="let blocControl of blocsFormArray.controls; let i = index" 
                 [formGroupName]="i" 
                 class="bloc-item">
              
              <mat-card class="bloc-card">
                <mat-card-header>
                  <mat-card-title class="bloc-title">
                    Bloc {{ i + 1 }}
                    <div class="bloc-actions">
                      <button type="button" mat-icon-button (click)="monterBloc(i)" 
                              [disabled]="i === 0" title="Monter">
                        <mat-icon>keyboard_arrow_up</mat-icon>
                      </button>
                      <button type="button" mat-icon-button (click)="descendreBloc(i)" 
                              [disabled]="i === blocsFormArray.length - 1" title="Descendre">
                        <mat-icon>keyboard_arrow_down</mat-icon>
                      </button>
                      <button type="button" mat-icon-button color="warn" (click)="supprimerBloc(i)" 
                              title="Supprimer">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </mat-card-title>
                </mat-card-header>

                <mat-card-content>
                  <div class="bloc-form">
                    <!-- Titre du bloc (obligatoire) -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Titre du bloc</mat-label>
                      <input matInput formControlName="titre" placeholder="Ex: Mobilisation articulaire">
                      <mat-error *ngIf="blocsFormArray.at(i).get('titre')?.invalid && blocsFormArray.at(i).get('titre')?.touched">
                        {{ getBlocErrorMessage(i, 'titre') }}
                      </mat-error>
                    </mat-form-field>

                    <!-- Ligne avec répétitions et temps -->
                    <div class="row">
                      <mat-form-field appearance="outline" class="half-width">
                        <mat-label>Répétitions</mat-label>
                        <input matInput formControlName="repetitions" placeholder="Ex: 3x10, 5 fois">
                      </mat-form-field>

                      <div class="half-width" style="display: flex; gap: 12px; align-items: flex-start;">
                        <mat-form-field appearance="outline" style="flex: 1 1 60%;">
                          <mat-label>Temps</mat-label>
                          <input matInput type="number" min="0" step="1" formControlName="tempsValeur" placeholder="Ex: 5">
                        </mat-form-field>
                        <mat-form-field appearance="outline" style="flex: 0 0 40%; min-width: 110px;">
                          <mat-label>Unité</mat-label>
                          <mat-select formControlName="tempsUnite">
                            <mat-option value="min">minutes</mat-option>
                            <mat-option value="sec">secondes</mat-option>
                          </mat-select>
                        </mat-form-field>
                      </div>
                    </div>

                    <!-- Informations supplémentaires -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Informations supplémentaires</mat-label>
                      <textarea matInput formControlName="informations" 
                                placeholder="Informations complémentaires..." 
                                rows="2"></textarea>
                    </mat-form-field>

                    <!-- Fonctionnement -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Fonctionnement</mat-label>
                      <textarea matInput formControlName="fonctionnement" 
                                placeholder="Description du fonctionnement de l'exercice..." 
                                rows="2"></textarea>
                    </mat-form-field>

                    <!-- Notes particulières -->
                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Notes particulières</mat-label>
                      <textarea matInput formControlName="notes" 
                                placeholder="Notes spécifiques pour ce bloc..." 
                                rows="2"></textarea>
                    </mat-form-field>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>

        <!-- Actions du formulaire -->
        <div class="form-actions">
          <button type="button" mat-button (click)="onCancel()" [disabled]="isLoading">
            Annuler
          </button>
          <button type="submit" mat-raised-button color="primary" [disabled]="isLoading || echauffementForm.invalid">
            <mat-icon *ngIf="isLoading">hourglass_empty</mat-icon>
            {{ isEditMode ? 'Modifier' : 'Créer' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
