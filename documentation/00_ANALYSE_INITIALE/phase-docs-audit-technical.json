{
  "phase": "docs-audit",
  "timestamp": "2025-11-05T13:50:00Z",
  "inputs_provided": [
    "README.md (top 400)",
    "STRATEGY.md (top 400)",
    "DEPLOYMENT.md (top 400)",
    "projet.md (top 400)",
    "docs/ (listing)",
    "documentation/ (listing)"
  ],
  "summary": "Audit documentaire: README et STRATEGY en décalage avec l'état réel (DB SQLite vs PostgreSQL, usage Supabase), DEPLOYMENT partiellement obsolète (env Supabase, commandes Render), projet.md ancien. Plan de consolidation proposé (quick/medium/long).",
  "details": [
    { "path": "README.md", "type": "file", "role": "doc", "size_bytes": 0, "notes": "Présente archi Backend Render + DB PostgreSQL (Supabase) et quickstart local avec PostgreSQL. Décrit modules et tags." },
    { "path": "STRATEGY.md", "type": "file", "role": "doc", "size_bytes": 0, "notes": "Stratégie: Front Vercel, Back Render, DB Supabase/PostgreSQL. Précise NO Supabase Auth/Storage (backend JWT only)." },
    { "path": "DEPLOYMENT.md", "type": "file", "role": "doc", "size_bytes": 0, "notes": "Guide Render/Vercel. Liste CLOUDINARY_*, CORS_ORIGINS. Exemple env.prod.ts minimal sans Supabase." },
    { "path": "projet.md", "type": "file", "role": "doc", "size_bytes": 0, "notes": "Décrit stack avec SQLite locale, manque environment.prod.ts (contraire au repo actuel)." },
    { "path": "docs/", "type": "dir", "role": "doc_set", "size_bytes": 0, "notes": "Nombreux guides (ARCHITECTURE, MIGRATION, openapi-specification.yaml, API guides, resolutions/...)." },
    { "path": "documentation/00_ANALYSE_INITIALE", "type": "dir", "role": "audit_outputs", "size_bytes": 0, "notes": "Sorties d'audit phases P0–P8." }
  ],
  "findings": [
    {
      "id": "DOC-CONTRADICT-DB-001",
      "title": "DB: README/STRATEGY déclarent PostgreSQL; code utilise Prisma SQLite",
      "severity": "high",
      "description": "README et STRATEGY affirment une base PostgreSQL (Supabase), cependant schema.prisma provider=sqlite et projet.md documente SQLite locale.",
      "evidence": [
        "README.md: 'Base de données: PostgreSQL, hébergée sur Supabase'",
        "STRATEGY.md: 'Base de données: PostgreSQL - Hébergement: Supabase'",
        "projet.md: 'Base de données : SQLite avec Prisma ORM'",
        "backend/prisma/schema.prisma: 'provider = \"sqlite\"'"
      ],
      "recommendation": "Décider DB cible (PostgreSQL en prod, SQLite en dev) et documenter clairement les deux chemins + migrations. Mettre README/STRATEGY/DEPLOYMENT en cohérence."
    },
    {
      "id": "DOC-CONTRADICT-AUTH-002",
      "title": "STRATEGY annonce pas de Supabase Auth; front expose supabaseUrl/supabaseKey et auth middleware s'attend à un JWT de Supabase",
      "severity": "medium",
      "description": "Le code frontend inclut SUPABASE_URL/KEY et le middleware lit decoded.user_metadata (schéma typique Supabase). STRATEGY interdit Supabase Auth.",
      "evidence": [
        "STRATEGY.md §4: 'Les autres services de Supabase (Auth, Storage) ne doivent pas être utilisés'",
        "frontend/src/environments/environment*.ts: 'supabaseUrl', 'supabaseKey'",
        "backend/middleware/auth.middleware.js: usage de decoded.user_metadata"
      ],
      "recommendation": "Choisir une politique: (A) Confirmer usage Supabase Auth et mettre STRATEGY à jour; ou (B) retirer Supabase côté front et s'appuyer sur auth backend."
    },
    {
      "id": "DOC-CONTRADICT-DEPLOY-003",
      "title": "DEPLOYMENT vs render.yaml (build/start) + env Supabase",
      "severity": "medium",
      "description": "DEPLOYMENT décrit Build/Start génériques ('npm install'/'npm start' root) tandis que render.yaml exécute 'cd backend && npm run deploy:render'. La doc d'env.prod.ts ne mentionne pas Supabase alors que le code produit en contient.",
      "evidence": [
        "DEPLOYMENT.md §2.1: Build Command: npm install; Start Command: npm start",
        "render.yaml: buildCommand: 'cd backend && npm install && npm run deploy:render'",
        "frontend/src/environments/environment.prod.ts: supabaseUrl/supabaseKey présents"
      ],
      "recommendation": "Aligner DEPLOYMENT.md avec render.yaml (y compris 'deploy:render') et expliciter variables front (SUPABASE_URL/ANON_KEY) avec recommandations de sécurité."
    },
    {
      "id": "DOC-OUTDATED-PROJET-004",
      "title": "projet.md obsolète (env prod manquant, SQLite seule)",
      "severity": "low",
      "description": "projet.md mentionne environment.prod.ts manquant (mais il existe) et ne couvre pas l'état Render/Vercel actuel.",
      "evidence": [
        "projet.md: 'environment.prod.ts (MANQUANT - À CRÉER)'",
        "frontend/src/environments/environment.prod.ts: présent"
      ],
      "recommendation": "Fusionner les sections pertinentes de projet.md dans README/ARCHITECTURE et archiver le document."
    }
  ],
  "commands_to_reproduce": [
    "Select-String -Path .\\README.md -Pattern 'PostgreSQL|Supabase'",
    "Select-String -Path .\\STRATEGY.md -Pattern 'Supabase'",
    "Select-String -Path .\\backend\\prisma\\schema.prisma -Pattern 'provider = \"sqlite\"'",
    "Get-Content .\\frontend\\src\\environments\\environment.prod.ts -TotalCount 80",
    "Get-Content .\\render.yaml -TotalCount 200"
  ],
  "next_steps": [
    "Quick wins (Semaine 1): Mettre DEPLOYMENT.md en cohérence (Render commands, envs Supabase) et ajouter un encart sécurité (rotation clés).",
    "Medium (Semaine 2): Décider politique Auth (Supabase vs backend) et DB cible (SQLite dev/Postgres prod); mettre à jour README/STRATEGY/ARCHITECTURE en conséquence.",
    "Long (Semaine 3+): Centraliser docs: README (overview+quickstart), ARCHITECTURE (détails), DEPLOYMENT (CI/CD), ARCHIVER projet.md et doc redondantes; ajouter un index docs stable."
  ],
  "doc_status": [
    {"path":"README.md","status":"keep","reason":"Point d'entrée; à corriger (DB, liens, quickstart)."},
    {"path":"STRATEGY.md","status":"keep","reason":"Référence d'architecture; à mettre à jour sur Auth/DB."},
    {"path":"DEPLOYMENT.md","status":"keep","reason":"Procédure prod; aligner commandes/env et sécurité Supabase."},
    {"path":"projet.md","status":"archive","reason":"Obsolète (env prod manquant, SQLite seule); contenu à fusionner vers README/ARCHITECTURE."},
    {"path":"docs/ARCHITECTURE.md","status":"merge","reason":"Fusionner avec STRATEGY.md ou en faire la version détaillée d'architecture."},
    {"path":"docs/MIGRATION*.md","status":"keep","reason":"Utile pour évolutions de schéma; vérifier redondance et pointer depuis README."}
  ],
  "consolidation_plan": {
    "quick_wins": [
      "Corriger DEPLOYMENT.md (render.yaml, env Supabase, CORS_ORIGINS).",
      "Ajouter avertissement sécurité (clés Supabase à rotater et sortir du repo).",
      "Pointer README vers les docs récentes (00_ANALYSE_INITIALE)."
    ],
    "medium": [
      "Mettre à jour STRATEGY.md (Auth/DB), préciser dev vs prod.",
      "Mettre README en cohérence (PostgreSQL prod; SQLite dev).",
      "Consolider ARCHITECTURE.md avec schémas actualisés."
    ],
    "long": [
      "Archiver projet.md; créer un index docs (docs/index.md) à jour.",
      "Ajouter un guide Sécurité (secrets, CORS, rate limit).",
      "Automatiser la vérification de cohérence docs via CI (lint-docs/check-links)."
    ],
    "checklist": [
      "[ ] DEPLOYMENT.md aligné avec render.yaml",
      "[ ] README: DB prod=Postgres; dev=SQLite; quickstart clair",
      "[ ] STRATEGY.md: position Auth Supabase vs backend",
      "[ ] ARCHITECTURE.md: mis à jour + diagrammes",
      "[ ] projet.md archivé (sections fusionnées)",
      "[ ] Ajout doc sécurité (clés, CORS, JWT)"
    ]
  }
}