{
  "phase": "security-secrets",
  "timestamp": "2025-11-05T13:55:00Z",
  "inputs_provided": [
    "grep: environments & secrets (SUPABASE/JWT/DATABASE/CLOUDINARY)",
    "backend/config/index.js",
    "backend/.env, .env.test, .env.example"
  ],
  "summary": "Plusieurs secrets sont committés (Supabase anon key, Cloudinary, JWT) et des fallbacks sensibles existent. CORS non branché sur whitelist. Remédiations et commandes de purge proposées.",
  "details": [
    { "path": "frontend/src/environments/environment.ts", "type": "file", "role": "env_dev", "size_bytes": 0, "notes": "SEC-LEAK-0001: supabaseUrl=<REDACTED>, supabaseKey=<REDACTED> (lignes 7-8)." },
    { "path": "frontend/src/environments/environment.prod.ts", "type": "file", "role": "env_prod", "size_bytes": 0, "notes": "SEC-LEAK-0002: supabaseUrl=<REDACTED>, supabaseKey=<REDACTED> (lignes 7-8)." },
    { "path": "backend/.env", "type": "file", "role": "env_local", "size_bytes": 0, "notes": "SEC-LEAK-0003..0006: DATABASE_URL=<REDACTED> (l4), CLOUDINARY_CLOUD_NAME=<REDACTED> (l11), CLOUDINARY_API_KEY=<REDACTED> (l12), CLOUDINARY_API_SECRET=<REDACTED> (l13), JWT_SECRET=<REDACTED> (l15), JWT_REFRESH_SECRET=<REDACTED> (l17)." },
    { "path": "backend/.env.test", "type": "file", "role": "env_test", "size_bytes": 0, "notes": "SEC-LEAK-0007..0009: DATABASE_URL=<REDACTED> (l3), JWT_SECRET=<REDACTED> (l6), JWT_REFRESH_SECRET=<REDACTED> (l8)." },
    { "path": "backend/.env.example", "type": "file", "role": "env_template", "size_bytes": 0, "notes": "Modèle avec placeholders (OK) mais contient une URL Postgres de démonstration (non sensible)." },
    { "path": "backend/config/index.js", "type": "code", "role": "config", "size_bytes": 0, "notes": "SEC-LEAK-0010 (prone): fallbacks secrets: jwt.secret='votre-secret-jwt-par-defaut', refreshSecret='votre-secret-refresh-par-defaut'." }
  ],
  "findings": [
    {
      "id": "SEC-LEAK-0001",
      "title": "Supabase URL/Key committées (dev)",
      "severity": "high",
      "description": "Clés Supabase (anon) présentes dans environment.ts.",
      "evidence": ["frontend/src/environments/environment.ts:7-8 supabaseUrl=<REDACTED>, supabaseKey=<REDACTED>"] ,
      "recommendation": "Retirer les valeurs du repo, injecter via variables d'env Vercel (PUBLIQUE anon) et faire une rotation de la clé si exposée."
    },
    {
      "id": "SEC-LEAK-0002",
      "title": "Supabase URL/Key committées (prod)",
      "severity": "high",
      "description": "Clés Supabase (anon) présentes dans environment.prod.ts.",
      "evidence": ["frontend/src/environments/environment.prod.ts:7-8 supabaseUrl=<REDACTED>, supabaseKey=<REDACTED>"],
      "recommendation": "Même remédiation: retirer, injecter via Vercel, régénérer la clé." 
    },
    {
      "id": "SEC-LEAK-0003",
      "title": "Secrets Cloudinary committés (.env)",
      "severity": "high",
      "description": "CLOUDINARY_CLOUD_NAME/API_KEY/API_SECRET présents dans backend/.env.",
      "evidence": [
        "backend/.env:11 CLOUDINARY_CLOUD_NAME=<REDACTED>",
        "backend/.env:12 CLOUDINARY_API_KEY=<REDACTED>",
        "backend/.env:13 CLOUDINARY_API_SECRET=<REDACTED>"
      ],
      "recommendation": "Ne pas committer .env; ajouter à .gitignore (déjà?), purger l'historique si nécessaire, et rotater les clés Cloudinary."
    },
    {
      "id": "SEC-LEAK-0004",
      "title": "JWT secrets committés (.env et .env.test)",
      "severity": "high",
      "description": "JWT_SECRET/JWT_REFRESH_SECRET présents.",
      "evidence": [
        "backend/.env:15 JWT_SECRET=<REDACTED>",
        "backend/.env.test:6 JWT_SECRET=<REDACTED>",
        "backend/.env.test:8 JWT_REFRESH_SECRET=<REDACTED>"
      ],
      "recommendation": "Rotater immédiatement les secrets JWT, retirer les fichiers de l'historique et utiliser des secrets Render (prod) et variables locales non committées."
    },
    {
      "id": "SEC-LEAK-0010",
      "title": "Fallback secrets en clair (prone)",
      "severity": "medium",
      "description": "config/index.js utilise des valeurs par défaut pour jwt.secret/refreshSecret s'ils sont absents.",
      "evidence": ["backend/config/index.js: jwt.secret || 'votre-secret-jwt-par-defaut'", "refreshSecret || 'votre-secret-refresh-par-defaut'"] ,
      "recommendation": "Refuser le démarrage si secrets absents en prod; supprimer les defaults."
    }
  ],
  "commands_to_reproduce": [
    "Select-String -Path .\\frontend\\src\\environments\\environment*.ts -Pattern 'supabase'",
    "Select-String -Path .\\backend\\.env* -Pattern 'DATABASE_URL|CLOUDINARY|JWT'",
    "Select-String -Path .\\backend\\config\\index.js -Pattern 'jwt\.secret|refreshSecret'"
  ],
  "remediation_plan": {
    "rotate_and_remove": [
      {
        "item": "Supabase anon key",
        "actions": [
          "Regénérer la clé dans Supabase (Project Settings → API)",
          "Supprimer les valeurs des fichiers environment*.ts et utiliser des variables Vercel (ex: SUPABASE_URL, SUPABASE_ANON_KEY)"
        ],
        "commands": [
          "# Exemple purge historique avec git filter-repo (à exécuter depuis la racine du repo)",
          "pip install git-filter-repo  # si non installé",
          "git filter-repo --path frontend/src/environments/environment.ts --invert-paths --force",
          "git filter-repo --path frontend/src/environments/environment.prod.ts --invert-paths --force"
        ]
      },
      {
        "item": "Cloudinary secrets (.env)",
        "actions": [
          "Créer/mettre à jour .gitignore pour exclure backend/.env et backend/.env.test",
          "Rotater les clés Cloudinary",
          "Supprimer ces fichiers de l'historique"
        ],
        "commands": [
          "Add-Content .gitignore \"backend/.env\nbackend/.env.test\"",
          "git rm --cached backend/.env backend/.env.test",
          "git commit -m 'chore(security): stop tracking env files'",
          "git filter-repo --path backend/.env --invert-paths --force",
          "git filter-repo --path backend/.env.test --invert-paths --force"
        ]
      },
      {
        "item": "JWT secrets",
        "actions": [
          "Créer de nouveaux secrets dans Render (JWT_SECRET, JWT_REFRESH_SECRET)",
          "Déployer après rotation"
        ],
        "commands": [
          "# Sur Render: définir de nouveaux secrets via dashboard",
          "# Local: mettre les secrets dans un .env local non committé"
        ]
      }
    ]
  },
  "cors_recommendation": {
    "pattern": "CSV whitelist via CORS_ORIGINS",
    "example_code": "const origins = (process.env.CORS_ORIGINS || '').split(',').map(s=>s.trim()).filter(Boolean);\napp.use(cors({\n  origin: (origin, cb) => {\n    if (!origin) return cb(null, true); // outils locaux\n    return origins.length === 0 || origins.includes(origin) ? cb(null, true) : cb(new Error('Not allowed by CORS'));\n  },\n  credentials: true\n}));"
  },
  "next_steps": [
    "Retirer/masquer toutes les clés committées et purger l'historique Git (filter-repo/BFG)",
    "Configurer CORS strict basé sur CORS_ORIGINS et supprimer les defaults de secrets",
    "Mettre à jour DEPLOYMENT.md avec la politique de secrets et variables Vercel/Render",
    "Déployer après rotation et validation"
  ]
}