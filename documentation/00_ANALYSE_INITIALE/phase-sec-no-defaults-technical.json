{
  "phase": "sec-no-defaults",
  "branch": "fix/security/jwt-config",
  "mode": "modification",
  "timestamp": "2025-11-05T16:56:00Z",
  "summary": "Suppression des valeurs par défaut des secrets JWT et échec au démarrage en production si secrets manquants.",
  "current_usages": [
    {
      "file": "backend/config/index.js",
      "before": [
        "jwt: {",
        "  secret: process.env.JWT_SECRET || 'votre-secret-jwt-par-defaut',",
        "  refreshSecret: process.env.JWT_REFRESH_SECRET || 'votre-secret-refresh-par-defaut',",
        "}"
      ],
      "after": [
        "// Validation préalable des secrets JWT (prod => exit si manquants)",
        "const isProd = process.env.NODE_ENV === 'production';",
        "if (!process.env.JWT_SECRET || !process.env.JWT_REFRESH_SECRET) {",
        "  if (isProd) { console.error('[Config] FATAL: JWT secrets are missing in production (JWT_SECRET/JWT_REFRESH_SECRET).'); process.exit(1); }",
        "  else { console.warn('[Config] Warning: JWT secrets missing; provide them via backend/.env (not tracked).'); }",
        "}",
        "jwt: {",
        "  secret: process.env.JWT_SECRET,",
        "  refreshSecret: process.env.JWT_REFRESH_SECRET,",
        "}"
      ]
    }
  ],
  "patch_files": ["backend/config/index.js"],
  "test_commands": [
    "# Production: doit quitter avec code d'erreur si secrets absents",
    "$env:NODE_ENV='production'; node backend/server.js; echo $LASTEXITCODE; $env:NODE_ENV=''",
    "# Développement: avertissement si secrets manquants, mais le serveur peut démarrer (selon le reste de la config)",
    "$env:NODE_ENV='development'; node backend/server.js"
  ],
  "acceptance_criteria": [
    "En production, le processus termine immédiatement avec un message FATAL si JWT_SECRET/JWT_REFRESH_SECRET manquent",
    "Aucune valeur par défaut de secret n'existe dans le code",
    "Les logs d'avertissement sont visibles en dev si secrets absents"
  ],
  "notes": [
    "Définir les secrets sur Render avant déploiement production",
    "Synchroniser la doc DEPLOYMENT.md pour refléter ce comportement"
  ]
}