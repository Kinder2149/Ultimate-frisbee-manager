{
  "phase": "backend-routes",
  "timestamp": "2025-11-05T13:20:00Z",
  "inputs_provided": [
    "backend/app.js",
    "backend/server.js",
    "backend/routes/index.js",
    "backend/routes/auth.routes.js",
    "backend/routes/admin.routes.js",
    "backend/routes/dashboard.routes.js",
    "backend/routes/echauffement.routes.js",
    "backend/routes/entrainement.routes.js",
    "backend/routes/exercice.routes.js",
    "backend/routes/situationmatch.routes.js (partially read)",
    "backend/routes/tag.routes.js",
    "backend/routes/health.routes.js",
    "backend/routes/import.routes.js",
    "backend/middleware/auth.middleware.js",
    "backend/middleware/validation.middleware.js",
    "backend/middleware/upload.middleware.js",
    "backend/config/index.js"
  ],
  "summary": "Cartographie des endpoints Express établie. Middlewares globaux: helmet, cors (sans restriction), express.json. Auth JWT appliquée aux routes protégées; pas de rate-limiting global; CORS potentiellement permissif.",
  "details": [
    { "path": "backend/app.js", "type": "code", "role": "entrypoint_setup", "size_bytes": 483, "notes": "app.use(helmet()); app.use(cors()); app.use(express.json()); routes init; error handler global." },
    { "path": "backend/server.js", "type": "code", "role": "entrypoint_server", "size_bytes": 1160, "notes": "Listen 0.0.0.0:PORT; connexion Prisma; shutdown propre." },
    { "path": "/api/health GET /", "type": "route", "role": "public", "size_bytes": 0, "notes": "health.routes.js -> inline handler; vérifie DB via prisma.$queryRaw('SELECT 1')." },
    { "path": "/api/auth POST /refresh", "type": "route", "role": "public", "size_bytes": 0, "notes": "auth.routes.js -> refreshToken (déprécié)." },
    { "path": "/api/auth GET /profile", "type": "route", "role": "protected", "size_bytes": 0, "notes": "controller: auth.controller.getProfile; middlewares: authenticateToken." },
    { "path": "/api/auth POST /logout", "type": "route", "role": "protected", "size_bytes": 0, "notes": "controller: auth.controller.logout; middlewares: authenticateToken." },
    { "path": "/api/auth PUT /profile", "type": "route", "role": "protected", "size_bytes": 0, "notes": "controller: auth.controller.updateProfile; middlewares: authenticateToken, createUploader('icon','avatars')." },

    { "path": "/api/exercices GET /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "exercice.controller.getAllExercices; uses prisma include tags." },
    { "path": "/api/exercices GET /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "exercice.controller.getExerciceById." },
    { "path": "/api/exercices POST /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "middlewares: uploader(image, 'exercices'), transformFormData, validate(createExerciceSchema), logBody; handler: createExercice." },
    { "path": "/api/exercices PUT /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "middlewares: uploader, transformFormData, logBody, validate(updateExerciceSchema); handler: updateExercice." },
    { "path": "/api/exercices POST /:id/duplicate", "type": "route", "role": "protected", "size_bytes": 0, "notes": "exercice.controller.duplicateExercice." },
    { "path": "/api/exercices DELETE /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "exercice.controller.deleteExercice." },

    { "path": "/api/tags GET /grouped", "type": "route", "role": "protected", "size_bytes": 0, "notes": "tag.controller.getGroupedTags." },
    { "path": "/api/tags GET /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "tag.controller.getAllTags." },
    { "path": "/api/tags GET /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "tag.controller.getTagById." },
    { "path": "/api/tags POST /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "validate(createTagSchema); tag.controller.createTag." },
    { "path": "/api/tags PUT /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "validate(updateTagSchema); tag.controller.updateTag." },
    { "path": "/api/tags DELETE /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "tag.controller.deleteTag." },

    { "path": "/api/entrainements GET /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "entrainement.controller.getAllEntrainements." },
    { "path": "/api/entrainements GET /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "entrainement.controller.getEntrainementById." },
    { "path": "/api/entrainements POST /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "uploader('image','entrainements'), transformFormData, validate(createEntrainementSchema); createEntrainement." },
    { "path": "/api/entrainements PUT /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "uploader, transformFormData, validate(updateEntrainementSchema); updateEntrainement." },
    { "path": "/api/entrainements POST /:id/duplicate", "type": "route", "role": "protected", "size_bytes": 0, "notes": "duplicateEntrainement." },
    { "path": "/api/entrainements DELETE /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "deleteEntrainement." },

    { "path": "/api/echauffements GET /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "echauffement.controller.getAllEchauffements." },
    { "path": "/api/echauffements GET /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "echauffement.controller.getEchauffementById." },
    { "path": "/api/echauffements POST /", "type": "route", "role": "protected", "size_bytes": 0, "notes": "uploader('image','echauffements'), transformFormData, validate(createEchauffementSchema); createEchauffement." },
    { "path": "/api/echauffements PUT /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "uploader, transformFormData, validate(updateEchauffementSchema); updateEchauffement." },
    { "path": "/api/echauffements DELETE /:id", "type": "route", "role": "protected", "size_bytes": 0, "notes": "deleteEchauffement; POST /:id/duplicate présent." },
    
    { "path": "/api/situations-matchs ...", "type": "route", "role": "protected", "size_bytes": 0, "notes": "pattern similaire: GET /, GET /:id, POST / (uploader+validate), PUT /:id (uploader+validate), DELETE /:id, POST /:id/duplicate." },

    { "path": "/api/dashboard GET /stats", "type": "route", "role": "protected", "size_bytes": 0, "notes": "dashboard.controller.getDashboardStats." },

    { "path": "/api/import POST /exercices", "type": "route", "role": "protected", "size_bytes": 0, "notes": "import.controller.importExercices; express.json({limit:'5mb'}) spécifique." },
    { "path": "/api/import POST /markdown", "type": "route", "role": "protected", "size_bytes": 0, "notes": "import.controller.importExercicesFromMarkdown; express.json({limit:'10mb'})." },

    { "path": "/api/admin/*", "type": "route", "role": "admin", "size_bytes": 0, "notes": "router.use(authenticateToken, requireAdmin). Endpoints: GET /overview, GET /all-content, GET /all-tags, GET /users, PATCH /users/:id, POST /users, POST /bulk-delete, POST /bulk-duplicate." },

    { "path": "middlewares", "type": "code", "role": "global_middlewares", "size_bytes": 0, "notes": "helmet (par défaut), cors() sans options (origins non restreints), express.json(); errorHandler global; authenticateToken appliqué par route index.js (sauf /auth, /health)." }
  ],
  "findings": [
    {
      "id": "SEC-CORS-OPEN",
      "title": "CORS potentiellement trop permissif",
      "severity": "high",
      "description": "app.use(cors()) sans configuration d'origines; le fichier config prévoit corsOrigins mais n'est pas utilisé.",
      "evidence": [
        "backend/app.js: app.use(cors());",
        "backend/config/index.js: corsOrigins défini dans config mais non passé à cors()"
      ],
      "recommendation": "Configurer cors({ origin: whitelist, credentials: true }) en lisant config.corsOrigins; restreindre aux domaines attendus."
    },
    {
      "id": "SEC-RATELIMIT-MISSING",
      "title": "Absence de rate limiting global et sur endpoints sensibles",
      "severity": "medium",
      "description": "express-rate-limit est importé dans auth.routes mais non utilisé; aucun rate-limit global appliqué sur /auth ou /admin.",
      "evidence": [
        "backend/routes/auth.routes.js: const rateLimit = require('express-rate-limit'); (non utilisé)",
        "backend/app.js: aucun app.use(rateLimit(...))"
      ],
      "recommendation": "Ajouter un rate limit (p.ex. 5 req/min) sur /api/auth et éventuellement sur /api/admin et /api/import." 
    },
    {
      "id": "SEC-JWT-DEFAULT-SECRET",
      "title": "Fallback de secrets JWT en clair dans la config",
      "severity": "high",
      "description": "config.jwt.secret et refreshSecret ont des valeurs par défaut codées; en prod cela peut exposer des tokens valides si les env vars sont absentes.",
      "evidence": [
        "backend/config/index.js: jwt.secret || 'votre-secret-jwt-par-defaut'",
        "backend/config/index.js: refreshSecret || 'votre-secret-refresh-par-defaut'"
      ],
      "recommendation": "Refuser de démarrer si les secrets ne sont pas définis (throw) et supprimer les valeurs par défaut." 
    },
    {
      "id": "SEC-UPLOAD-ATTACK-SURFACE",
      "title": "Endpoints upload exposés (Cloudinary) — vérifier auth et validations",
      "severity": "medium",
      "description": "Les routes POST/PUT avec upload sont protégées par authenticateToken et limitent le type/taille; risque restant: absence d'antivirus/scan et transformation d'images." ,
      "evidence": [
        "upload.middleware.js: limits { fileSize: 5MB }, fileFilter image only",
        "routes: POST/PUT utilisant createUploader(...)"
      ],
      "recommendation": "Conserver l'auth obligatoire, journaliser les uploads, envisager un scan/validation côté Cloudinary; limiter davantage les tailles si nécessaire." 
    },
    {
      "id": "OBS-REFRESH-DEPRECATED",
      "title": "Route /api/auth/refresh probablement obsolète",
      "severity": "low",
      "description": "Commentée comme dépréciée (Supabase côté client gère le refresh).",
      "evidence": [
        "auth.routes.js: // Peut être déprécié"
      ],
      "recommendation": "Déprécier officiellement et planifier sa suppression pour réduire la surface d'attaque." 
    },
    {
      "id": "OBS-NO-HTTP-LOGGING",
      "title": "Absence de logging HTTP centralisé",
      "severity": "low",
      "description": "Aucun middleware de type morgan/pino-http n'est configuré pour tracer les requêtes.",
      "evidence": [
        "backend/app.js: aucun app.use(morgan(...))"
      ],
      "recommendation": "Ajouter morgan (dev) ou pino-http (prod) avec masquage d'entêtes sensibles." 
    }
  ],
  "commands_to_reproduce": [
    "Select-String -Path .\\backend\\app.js -Pattern 'cors\(' -CaseSensitive:$false",
    "Select-String -Path .\\backend\\config\\index.js -Pattern 'corsOrigins' -CaseSensitive:$false",
    "Select-String -Path .\\backend\\routes\\auth.routes.js -Pattern 'rateLimit' -CaseSensitive:$false",
    "Select-String -Path .\\backend\\app.js -Pattern 'rateLimit' -CaseSensitive:$false",
    "curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3002/api/health",
    "curl -i http://localhost:3002/api/health",
    "curl -i -X GET http://localhost:3002/api/auth/profile",
    "curl -i -X POST http://localhost:3002/api/auth/refresh",
    "curl -i -X GET http://localhost:3002/api/dashboard/stats"
  ],
  "next_steps": [
    "Brancher cors() sur config.corsOrigins (liste blanche) et activer credentials si nécessaire.",
    "Mettre un rate-limit sur /api/auth (et éventuellement /api/admin, /api/import).",
    "Supprimer les valeurs par défaut des secrets JWT et faire échouer le démarrage si absents en prod.",
    "Ajouter un middleware de logging HTTP (morgan/pino-http) et filtrer les données sensibles.",
    "Passer en revue /api/auth/refresh et planifier sa suppression si inutile."
  ]
}