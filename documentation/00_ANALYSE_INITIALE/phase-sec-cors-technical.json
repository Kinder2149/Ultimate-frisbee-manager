{
  "phase": "sec-cors",
  "branch": "feat/security/cors-whitelist",
  "mode": "modification",
  "timestamp": "2025-11-05T15:55:00Z",
  "summary": "Mise en place d'une whitelist CORS via CORS_ORIGINS (CSV) et activation de credentials.",
  "current_locations": [
    {
      "file": "backend/app.js",
      "line_match": "app.use(cors());",
      "context": [
        "// Middlewares de sécurité",
        "app.use(helmet());",
        "app.use(cors());",
        "// Middleware pour parser le JSON"
      ]
    }
  ],
  "patch_summary": {
    "file": "backend/app.js",
    "before": "app.use(cors());",
    "after": [
      "const allowedOrigins = (process.env.CORS_ORIGINS || '')",
      "  .split(',')",
      "  .map(s => s.trim())",
      "  .filter(Boolean);",
      "app.use(cors({",
      "  origin: (origin, callback) => {",
      "    if (!origin) return callback(null, true);",
      "    return allowedOrigins.includes(origin)",
      "      ? callback(null, true)",
      "      : callback(new Error('CORS not allowed'), false);",
      "  },",
      "  credentials: true",
      "}));"
    ]
  },
  "env_instructions": {
    "variable": "CORS_ORIGINS",
    "example": "https://app.example.com,https://admin.example.com",
    "where": [
      "Render → Backend Service → Environment → Add Secret",
      "Local dev: backend/.env (non committé)"
    ]
  },
  "tests": {
    "allowed_origin": "curl -i https://ultimate-frisbee-manager-api.onrender.com/api/health -H 'Origin: https://app.example.com' -H 'Accept: application/json'",
    "blocked_origin": "curl -i https://ultimate-frisbee-manager-api.onrender.com/api/health -H 'Origin: https://evil.example' -H 'Accept: application/json'",
    "notes": "Attendu: 200 avec Origin autorisé; 403/erreur CORS pour Origine non listée (le navigateur bloque; en curl on doit voir l'absence des en-têtes CORS)."
  },
  "next_steps": [
    "Définir la variable CORS_ORIGINS sur Render (Production) et sur l'env de preview si utilisé",
    "Redéployer le backend",
    "Vérifier les logs et les appels depuis le frontend Vercel"
  ]
}